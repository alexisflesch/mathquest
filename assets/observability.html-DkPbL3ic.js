import{_ as n,c as e,a,o as i}from"./app-Blvv7Pu1.js";const t={};function l(o,s){return i(),e("div",null,s[0]||(s[0]=[a(`<h1 id="observability-runbooks" tabindex="-1"><a class="header-anchor" href="#observability-runbooks"><span>Observability Runbooks</span></a></h1><p>Phase 5 observability features provide tools for tracing requests and monitoring system health.</p><h2 id="correlation-id-tracing" tabindex="-1"><a class="header-anchor" href="#correlation-id-tracing"><span>Correlation ID Tracing</span></a></h2><h3 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h3><p>Every client request generates a unique <strong>correlation ID</strong> that flows through the entire system, enabling end-to-end tracing.</p><p><strong>Format:</strong> <code>{prefix}-{timestamp}-{random}</code></p><ul><li>Example: <code>client-1730000000000-a1b2c3d4</code></li><li>Prefix: <code>client</code> (frontend) or <code>server</code> (backend)</li><li>Timestamp: 13-digit Unix timestamp (milliseconds)</li><li>Random: 8-character lowercase alphanumeric</li></ul><h3 id="how-to-trace-a-session" tabindex="-1"><a class="header-anchor" href="#how-to-trace-a-session"><span>How to Trace a Session</span></a></h3><h4 id="_1-find-the-correlation-id" tabindex="-1"><a class="header-anchor" href="#_1-find-the-correlation-id"><span>1. Find the Correlation ID</span></a></h4><p><strong>In browser console logs:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">[10:23:45] [INFO] [useGameSocket] [CID:a1b2c3d4] Emitting join_game</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>In backend logs:</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">2025-10-27 10:23:45.123 info [JoinGameHandler] [CID:a1b2c3d4] Received join_game payload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>The <code>[CID:xxxxxxxx]</code> marker shows the last 8 characters of the correlation ID.</p><h4 id="_2-search-logs-for-the-full-flow" tabindex="-1"><a class="header-anchor" href="#_2-search-logs-for-the-full-flow"><span>2. Search Logs for the Full Flow</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Search backend logs for a specific correlation ID</span></span>
<span class="line"><span class="token function">grep</span> <span class="token string">&quot;a1b2c3d4&quot;</span> /path/to/backend/logs/combined.log</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Search frontend browser console</span></span>
<span class="line"><span class="token comment"># Open DevTools → Console → Filter: &quot;a1b2c3d4&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-typical-flow-pattern" tabindex="-1"><a class="header-anchor" href="#_3-typical-flow-pattern"><span>3. Typical Flow Pattern</span></a></h4><p>A complete join→question→answer flow will show:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">[Frontend] [CID:a1b2c3d4] Emitting join_game</span>
<span class="line">[Backend]  [CID:a1b2c3d4] Received join_game payload</span>
<span class="line">[Backend]  [CID:a1b2c3d4] Looking up gameInstance</span>
<span class="line">[Backend]  [CID:a1b2c3d4] Emitting game_joined</span>
<span class="line">[Frontend] [CID:a1b2c3d4] Received game_joined</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="common-scenarios" tabindex="-1"><a class="header-anchor" href="#common-scenarios"><span>Common Scenarios</span></a></h3><h4 id="trace-a-specific-user-s-issue" tabindex="-1"><a class="header-anchor" href="#trace-a-specific-user-s-issue"><span>Trace a Specific User&#39;s Issue</span></a></h4><ol><li>Ask user to open browser console</li><li>Have them perform the action (e.g., join game)</li><li>Look for <code>[CID:xxxxxxxx]</code> in their console logs</li><li>Search backend logs for matching correlation ID</li><li>Trace full request flow to find where it broke</li></ol><h4 id="investigate-stuck-join-requests" tabindex="-1"><a class="header-anchor" href="#investigate-stuck-join-requests"><span>Investigate &quot;Stuck&quot; Join Requests</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Find all join_game events in last hour</span></span>
<span class="line"><span class="token function">grep</span> <span class="token string">&quot;join_game&quot;</span> logs/combined.log <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;1 hour ago&#39;</span> <span class="token string">&#39;+%Y-%m-%d %H&#39;</span><span class="token variable">)</span></span>&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Look for correlation IDs without corresponding &quot;game_joined&quot;</span></span>
<span class="line"><span class="token comment"># These indicate failed or stuck requests</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="metrics-monitoring" tabindex="-1"><a class="header-anchor" href="#metrics-monitoring"><span>Metrics Monitoring</span></a></h2><h3 id="enable-metrics-collection" tabindex="-1"><a class="header-anchor" href="#enable-metrics-collection"><span>Enable Metrics Collection</span></a></h3><p>Set environment variable:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token assign-left variable">ENABLE_METRICS</span><span class="token operator">=</span>true</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Note:</strong> Only enable in dev/staging environments. Not intended for production load.</p><h3 id="access-metrics-endpoint" tabindex="-1"><a class="header-anchor" href="#access-metrics-endpoint"><span>Access Metrics Endpoint</span></a></h3><p><strong>Current snapshot:</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">curl</span> http://localhost:3000/api/v1/metrics</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Response:</strong></p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;currentMinute&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;joinGame&quot;</span><span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;gameQuestion&quot;</span><span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;submitAnswer&quot;</span><span class="token operator">:</span> <span class="token number">380</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;rates&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;joinGamePerMin&quot;</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;gameQuestionPerMin&quot;</span><span class="token operator">:</span> <span class="token number">115</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;submitAnswerPerMin&quot;</span><span class="token operator">:</span> <span class="token number">365</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;alerts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;metric&quot;</span><span class="token operator">:</span> <span class="token string">&quot;submit_answer&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;rate&quot;</span><span class="token operator">:</span> <span class="token number">530</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;threshold&quot;</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;severity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;warning&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1730000000000</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Historical data:</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">curl</span> http://localhost:3000/api/v1/metrics/history?minutes<span class="token operator">=</span><span class="token number">10</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="alert-thresholds" tabindex="-1"><a class="header-anchor" href="#alert-thresholds"><span>Alert Thresholds</span></a></h3><table><thead><tr><th>Metric</th><th>Threshold (per minute)</th><th>Interpretation</th></tr></thead><tbody><tr><td><code>join_game</code></td><td>100</td><td>&gt;100 joins/min indicates potential spam or load test</td></tr><tr><td><code>game_question</code></td><td>200</td><td>&gt;200 questions/min indicates rapid teacher question switching</td></tr><tr><td><code>submit_answer</code></td><td>500</td><td>&gt;500 answers/min indicates high concurrent gameplay or storm</td></tr></tbody></table><p><strong>Severity Levels:</strong></p><ul><li><code>warning</code>: Rate &gt; threshold</li><li><code>critical</code>: Rate &gt; threshold × 2</li></ul><h3 id="investigating-storm-events" tabindex="-1"><a class="header-anchor" href="#investigating-storm-events"><span>Investigating Storm Events</span></a></h3><p>A &quot;storm&quot; occurs when many users submit answers simultaneously, overwhelming the system.</p><h4 id="_1-check-metrics-for-spikes" tabindex="-1"><a class="header-anchor" href="#_1-check-metrics-for-spikes"><span>1. Check Metrics for Spikes</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">curl</span> http://localhost:3000/api/v1/metrics <span class="token operator">|</span> jq <span class="token string">&#39;.alerts&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>If <code>submit_answer</code> shows critical alert, investigate:</p><h4 id="_2-find-affected-game" tabindex="-1"><a class="header-anchor" href="#_2-find-affected-game"><span>2. Find Affected Game</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Search for submit_answer events in last 5 minutes</span></span>
<span class="line"><span class="token function">grep</span> <span class="token string">&quot;submit_answer&quot;</span> logs/combined.log <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-100</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Look for accessCode patterns</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-oP</span> <span class="token string">&#39;accessCode&quot;:&quot;\\\\K[^&quot;]+&#39;</span> logs/combined.log <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-nr</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-check-redis-queue-depth" tabindex="-1"><a class="header-anchor" href="#_3-check-redis-queue-depth"><span>3. Check Redis Queue Depth</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Connect to Redis</span></span>
<span class="line">redis-cli</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Check pending answer queue (if implemented)</span></span>
<span class="line">LLEN mathquest:queue:answers</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Check game participant counts</span></span>
<span class="line">HLEN mathquest:game:participants:GAME123</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-correlate-with-timer-events" tabindex="-1"><a class="header-anchor" href="#_4-correlate-with-timer-events"><span>4. Correlate with Timer Events</span></a></h4><p>Storm events often occur at timer expiration. Check:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Find timer_expired events near storm timestamp</span></span>
<span class="line"><span class="token function">grep</span> <span class="token string">&quot;timer_expired&quot;</span> logs/combined.log <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;2025-10-27 10:23&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="troubleshooting-guide" tabindex="-1"><a class="header-anchor" href="#troubleshooting-guide"><span>Troubleshooting Guide</span></a></h2><h3 id="symptom-user-reports-stuck-on-loading" tabindex="-1"><a class="header-anchor" href="#symptom-user-reports-stuck-on-loading"><span>Symptom: User Reports &quot;Stuck on Loading&quot;</span></a></h3><p><strong>Steps:</strong></p><ol><li>Get correlation ID from user&#39;s browser console</li><li>Search backend logs for that ID</li><li>Look for error responses or missing <code>game_joined</code> event</li><li>Common causes: <ul><li>Invalid access code (check <code>game_error</code> emission)</li><li>Database timeout (check <code>gameInstance lookup</code> timing)</li><li>WebSocket disconnect (check connection handlers)</li></ul></li></ol><h3 id="symptom-leaderboard-not-updating" tabindex="-1"><a class="header-anchor" href="#symptom-leaderboard-not-updating"><span>Symptom: Leaderboard Not Updating</span></a></h3><p><strong>Steps:</strong></p><ol><li>Check if correlation IDs flow through <code>submit_answer</code></li><li>Verify Redis score updates: <code>ZSCORE mathquest:game:leaderboard:GAME123 userId</code></li><li>Check for idempotency guard blocks (duplicate submissions)</li><li>Verify <code>leaderboard_update</code> emission after score change</li></ol><h3 id="symptom-high-alert-rate-on-metrics" tabindex="-1"><a class="header-anchor" href="#symptom-high-alert-rate-on-metrics"><span>Symptom: High Alert Rate on Metrics</span></a></h3><p><strong>Steps:</strong></p><ol><li>Check <code>/api/v1/metrics</code> for alert severity</li><li>If warning: Monitor, may be legitimate load</li><li>If critical: Investigate immediately <ul><li>Check for infinite loops (same correlation ID repeating)</li><li>Check for spam/bot activity (rapid joins from same IP)</li><li>Check for teacher rapidly clicking buttons</li></ul></li></ol><h2 id="best-practices" tabindex="-1"><a class="header-anchor" href="#best-practices"><span>Best Practices</span></a></h2><h3 id="for-developers" tabindex="-1"><a class="header-anchor" href="#for-developers"><span>For Developers</span></a></h3><ol><li><strong>Always include correlation IDs</strong> in new socket event payloads</li><li><strong>Log correlation IDs</strong> at key decision points (validation, database queries, emissions)</li><li><strong>Use structured logging</strong> with metadata objects (not string concatenation)</li><li><strong>Preserve correlation IDs</strong> across async boundaries</li></ol><h3 id="for-operators" tabindex="-1"><a class="header-anchor" href="#for-operators"><span>For Operators</span></a></h3><ol><li><strong>Enable metrics in staging</strong> to establish baseline rates</li><li><strong>Monitor alerts</strong> for unusual patterns</li><li><strong>Keep logs</strong> for at least 7 days for post-incident analysis</li><li><strong>Document incidents</strong> with correlation ID examples for future reference</li></ol><h2 id="architecture-notes" tabindex="-1"><a class="header-anchor" href="#architecture-notes"><span>Architecture Notes</span></a></h2><h3 id="correlation-id-lifecycle" tabindex="-1"><a class="header-anchor" href="#correlation-id-lifecycle"><span>Correlation ID Lifecycle</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">┌─────────────┐</span>
<span class="line">│   Client    │ Generates: client-timestamp-random</span>
<span class="line">│  (Browser)  │</span>
<span class="line">└──────┬──────┘</span>
<span class="line">       │ WebSocket (join_game payload)</span>
<span class="line">       ▼</span>
<span class="line">┌─────────────┐</span>
<span class="line">│   Backend   │ Extracts from payload</span>
<span class="line">│  (Socket)   │ Logs with [CID:xxxxxxxx]</span>
<span class="line">└──────┬──────┘</span>
<span class="line">       │ Responses flow back with same ID</span>
<span class="line">       ▼</span>
<span class="line">┌─────────────┐</span>
<span class="line">│   Client    │ Logs received events with [CID:xxxxxxxx]</span>
<span class="line">│  (Browser)  │</span>
<span class="line">└─────────────┘</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="metrics-collection" tabindex="-1"><a class="header-anchor" href="#metrics-collection"><span>Metrics Collection</span></a></h3><ul><li><strong>In-memory only</strong> (no database writes)</li><li><strong>1-minute buckets</strong> (rolling window)</li><li><strong>10-minute history</strong> (last 10 buckets kept)</li><li><strong>Automatic rotation</strong> every 60 seconds</li><li><strong>Gated by env var</strong> (disabled by default)</li></ul><h3 id="why-not-production" tabindex="-1"><a class="header-anchor" href="#why-not-production"><span>Why Not Production?</span></a></h3><p>Current metrics implementation:</p><ul><li>❌ No persistence (lost on restart)</li><li>❌ No aggregation across instances</li><li>❌ No historical analysis</li><li>❌ Limited alert capabilities</li></ul><p>For production observability, integrate:</p><ul><li>Prometheus for metrics</li><li>Grafana for visualization</li><li>ELK/Loki for log aggregation</li><li>Distributed tracing (Jaeger/Zipkin)</li></ul>`,77)]))}const c=n(t,[["render",l]]),p=JSON.parse('{"path":"/dev/observability.html","title":"Observability Runbooks","lang":"fr-FR","frontmatter":{},"git":{"updatedTime":1761598591000,"contributors":[{"name":"alexisflesch","username":"alexisflesch","email":"alexis.flesch@gmail.com","commits":1,"url":"https://github.com/alexisflesch"}],"changelog":[{"hash":"6d717b71ce3a947d83cd99a93af8ef20f5266fa9","time":1761598591000,"email":"alexis.flesch@gmail.com","author":"alexisflesch","message":"feat: Phase 5 - Observability (Correlation IDs + Metrics)"}]},"filePathRelative":"dev/observability.md"}');export{c as comp,p as data};
