import{_ as n,c as a,a as e,o as p}from"./app-DoDG4mLI.js";const t={};function l(i,s){return p(),a("div",null,s[0]||(s[0]=[e(`<h1 id="configuration-et-environnement" tabindex="-1"><a class="header-anchor" href="#configuration-et-environnement"><span>Configuration et environnement</span></a></h1><h2 id="vue-d-ensemble" tabindex="-1"><a class="header-anchor" href="#vue-d-ensemble"><span>Vue d&#39;ensemble</span></a></h2><p>MathQuest utilise plusieurs fichiers de configuration et variables d&#39;environnement pour gérer différents aspects de l&#39;application. Cette section détaille toutes les options de configuration disponibles.</p><h2 id="variables-d-environnement" tabindex="-1"><a class="header-anchor" href="#variables-d-environnement"><span>Variables d&#39;environnement</span></a></h2><h3 id="variables-obligatoires" tabindex="-1"><a class="header-anchor" href="#variables-obligatoires"><span>Variables obligatoires</span></a></h3><h4 id="base-de-donnees" tabindex="-1"><a class="header-anchor" href="#base-de-donnees"><span>Base de données</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># URL de connexion PostgreSQL</span></span>
<span class="line"><span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span><span class="token string">&quot;postgresql://username:password@localhost:5432/mathquest&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cache-redis" tabindex="-1"><a class="header-anchor" href="#cache-redis"><span>Cache Redis</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># URL de connexion Redis</span></span>
<span class="line"><span class="token assign-left variable">REDIS_URL</span><span class="token operator">=</span><span class="token string">&quot;redis://localhost:6379&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="authentification-jwt" tabindex="-1"><a class="header-anchor" href="#authentification-jwt"><span>Authentification JWT</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Clé secrète pour les tokens JWT (minimum 32 caractères)</span></span>
<span class="line"><span class="token assign-left variable">JWT_SECRET</span><span class="token operator">=</span><span class="token string">&quot;your_super_secure_jwt_secret_key_here&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="variables-recommandees" tabindex="-1"><a class="header-anchor" href="#variables-recommandees"><span>Variables recommandées</span></a></h3><h4 id="configuration-serveur" tabindex="-1"><a class="header-anchor" href="#configuration-serveur"><span>Configuration serveur</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Port d&#39;écoute du serveur (défaut: 3007)</span></span>
<span class="line"><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3007</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Niveau de log (DEBUG, INFO, WARN, ERROR)</span></span>
<span class="line"><span class="token assign-left variable">LOG_LEVEL</span><span class="token operator">=</span>INFO</span>
<span class="line"></span>
<span class="line"><span class="token comment"># URL du frontend pour CORS (production)</span></span>
<span class="line"><span class="token assign-left variable">FRONTEND_URL</span><span class="token operator">=</span><span class="token string">&quot;https://yourdomain.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Domaine de l&#39;application</span></span>
<span class="line"><span class="token assign-left variable">APP_DOMAIN</span><span class="token operator">=</span><span class="token string">&quot;yourdomain.com&quot;</span></span>
<span class="line"><span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span><span class="token string">&quot;MathQuest&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="securite" tabindex="-1"><a class="header-anchor" href="#securite"><span>Sécurité</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Mot de passe administrateur pour les inscriptions enseignants</span></span>
<span class="line"><span class="token assign-left variable">ADMIN_PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;secure_admin_password&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Configuration email (Brevo/Sendinblue)</span></span>
<span class="line"><span class="token assign-left variable">BREVO_API_KEY</span><span class="token operator">=</span><span class="token string">&quot;your_brevo_api_key&quot;</span></span>
<span class="line"><span class="token assign-left variable">BREVO_SENDER_EMAIL</span><span class="token operator">=</span><span class="token string">&quot;noreply@yourdomain.com&quot;</span></span>
<span class="line"><span class="token assign-left variable">BREVO_SENDER_NAME</span><span class="token operator">=</span><span class="token string">&quot;MathQuest&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="email-et-verification" tabindex="-1"><a class="header-anchor" href="#email-et-verification"><span>Email et vérification</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Durée d&#39;expiration des tokens</span></span>
<span class="line"><span class="token assign-left variable">EMAIL_VERIFICATION_TOKEN_EXPIRY</span><span class="token operator">=</span><span class="token string">&quot;24h&quot;</span></span>
<span class="line"><span class="token assign-left variable">PASSWORD_RESET_TOKEN_EXPIRY</span><span class="token operator">=</span><span class="token string">&quot;1h&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="fichiers-de-configuration" tabindex="-1"><a class="header-anchor" href="#fichiers-de-configuration"><span>Fichiers de configuration</span></a></h2><h3 id="pm2-ecosystem-configuration" tabindex="-1"><a class="header-anchor" href="#pm2-ecosystem-configuration"><span>PM2 Ecosystem Configuration</span></a></h3><p>Le fichier <code>ecosystem.config.js</code> configure le déploiement avec PM2 :</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">apps</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;mathquest-backend&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">script</span><span class="token operator">:</span> <span class="token string">&quot;npm&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">&quot;./backend&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token string">&quot;run start&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token constant">REDIS_URL</span><span class="token operator">:</span> <span class="token string">&quot;redis://localhost:6379&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token constant">DATABASE_URL</span><span class="token operator">:</span> <span class="token string">&quot;postgresql://...&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token constant">JWT_SECRET</span><span class="token operator">:</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token constant">FRONTEND_URL</span><span class="token operator">:</span> <span class="token string">&quot;https://yourdomain.com&quot;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">log_file</span><span class="token operator">:</span> <span class="token string">&quot;./logs/pm2-backend.log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">out_file</span><span class="token operator">:</span> <span class="token string">&quot;./logs/pm2-backend-out.log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">error_file</span><span class="token operator">:</span> <span class="token string">&quot;./logs/pm2-backend-error.log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">log_date_format</span><span class="token operator">:</span> <span class="token string">&quot;YYYY-MM-DD HH:mm:ss Z&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">merge_logs</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">max_memory_restart</span><span class="token operator">:</span> <span class="token string">&quot;400M&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;mathquest-frontend&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">script</span><span class="token operator">:</span> <span class="token string">&quot;npm&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">&quot;./frontend&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token string">&quot;run start:minimal&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token constant">NEXT_TELEMETRY_DISABLED</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">log_file</span><span class="token operator">:</span> <span class="token string">&quot;./logs/pm2-frontend.log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">out_file</span><span class="token operator">:</span> <span class="token string">&quot;./logs/pm2-frontend-out.log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">error_file</span><span class="token operator">:</span> <span class="token string">&quot;./logs/pm2-frontend-error.log&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">log_date_format</span><span class="token operator">:</span> <span class="token string">&quot;YYYY-MM-DD HH:mm:ss Z&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">merge_logs</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">max_memory_restart</span><span class="token operator">:</span> <span class="token string">&quot;300M&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configuration-next-js" tabindex="-1"><a class="header-anchor" href="#configuration-next-js"><span>Configuration Next.js</span></a></h3><p>Le fichier <code>next.config.ts</code> configure l&#39;application frontend :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token punctuation">{</span>import(&#39;next&#39;).NextConfig<span class="token punctuation">}</span> */</span></span>
<span class="line"><span class="token keyword">const</span> nextConfig <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// Configuration de base</span></span>
<span class="line">  reactStrictMode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Configuration des images</span></span>
<span class="line">  images<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    domains<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    unoptimized<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;development&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Headers de sécurité</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        source<span class="token operator">:</span> <span class="token string">&#39;/(.*)&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        headers<span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">          <span class="token punctuation">{</span></span>
<span class="line">            key<span class="token operator">:</span> <span class="token string">&#39;X-Frame-Options&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            value<span class="token operator">:</span> <span class="token string">&#39;DENY&#39;</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">{</span></span>
<span class="line">            key<span class="token operator">:</span> <span class="token string">&#39;X-Content-Type-Options&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            value<span class="token operator">:</span> <span class="token string">&#39;nosniff&#39;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Variables d&#39;environnement exposées au frontend</span></span>
<span class="line">  env<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">NEXT_PUBLIC_APP_NAME</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_NAME</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">NEXT_PUBLIC_APP_DOMAIN</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_DOMAIN</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> nextConfig<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configuration-eslint" tabindex="-1"><a class="header-anchor" href="#configuration-eslint"><span>Configuration ESLint</span></a></h3><p>Le fichier <code>eslint.config.mjs</code> définit les règles de linting :</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;eslint-define-config&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">browser</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">es2021</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">node</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&#39;eslint:recommended&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;@typescript-eslint/recommended&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;plugin:react/recommended&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;plugin:react-hooks/recommended&#39;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">parser</span><span class="token operator">:</span> <span class="token string">&#39;@typescript-eslint/parser&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">parserOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">ecmaFeatures</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">jsx</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">ecmaVersion</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;react&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;@typescript-eslint&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Règles personnalisées</span></span>
<span class="line">    <span class="token string-property property">&#39;react/react-in-jsx-scope&#39;</span><span class="token operator">:</span> <span class="token string">&#39;off&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;@typescript-eslint/no-unused-vars&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">argsIgnorePattern</span><span class="token operator">:</span> <span class="token string">&#39;^_&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;no-console&#39;</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">?</span> <span class="token string">&#39;error&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;warn&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">settings</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">&#39;detect&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="configuration-de-la-base-de-donnees" tabindex="-1"><a class="header-anchor" href="#configuration-de-la-base-de-donnees"><span>Configuration de la base de données</span></a></h2><h3 id="prisma-schema" tabindex="-1"><a class="header-anchor" href="#prisma-schema"><span>Prisma Schema</span></a></h3><p>Le fichier <code>schema.prisma</code> définit le modèle de données :</p><div class="language-prisma line-numbers-mode" data-highlighter="prismjs" data-ext="prisma"><pre><code class="language-prisma"><span class="line">generator client {</span>
<span class="line">  provider = &quot;prisma-client-js&quot;</span>
<span class="line">  output   = &quot;../src/db/generated/client&quot;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">datasource db {</span>
<span class="line">  provider = &quot;postgresql&quot;</span>
<span class="line">  url      = env(&quot;DATABASE_URL&quot;)</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">// Modèles de données...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configuration-de-connexion" tabindex="-1"><a class="header-anchor" href="#configuration-de-connexion"><span>Configuration de connexion</span></a></h3><p>La connexion Prisma est configurée dans <code>src/db/prisma.ts</code> :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/db/generated/client&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Singleton pattern pour éviter les connexions multiples</span></span>
<span class="line"><span class="token keyword">declare</span> global <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> prisma<span class="token operator">:</span> PrismaClient <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> prisma <span class="token operator">=</span> global<span class="token punctuation">.</span>prisma <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  log<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;development&#39;</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">&#39;query&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;warn&#39;</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  global<span class="token punctuation">.</span>prisma <span class="token operator">=</span> prisma<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="configuration-redis" tabindex="-1"><a class="header-anchor" href="#configuration-redis"><span>Configuration Redis</span></a></h2><h3 id="connexion-redis" tabindex="-1"><a class="header-anchor" href="#connexion-redis"><span>Connexion Redis</span></a></h3><p>Le fichier <code>src/config/redis.ts</code> configure la connexion Redis :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> Redis <span class="token keyword">from</span> <span class="token string">&#39;ioredis&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../utils/logger&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> redisUrl <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_URL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;REDIS_URL is not defined in environment variables.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;REDIS_URL is not defined.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> redisClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span>redisUrl<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  maxRetriesPerRequest<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  enableReadyCheck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  retryDelayOnFailover<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">  maxRetriesPerRequest<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">  lazyConnect<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;Successfully connected to Redis.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Redis connection error:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span> redisClient <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cles-redis-utilisees" tabindex="-1"><a class="header-anchor" href="#cles-redis-utilisees"><span>Clés Redis utilisées</span></a></h3><p>MathQuest utilise plusieurs patterns de clés Redis :</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># États de partie</span>
<span class="line">mathquest:game:{accessCode}</span>
<span class="line"></span>
<span class="line"># Timers de questions</span>
<span class="line">mathquest:timer:{accessCode}:{questionUid}</span>
<span class="line"></span>
<span class="line"># Sessions utilisateur</span>
<span class="line">mathquest:session:{userId}</span>
<span class="line"></span>
<span class="line"># Cache des questions</span>
<span class="line">mathquest:question:{questionUid}</span>
<span class="line"></span>
<span class="line"># Leaderboards</span>
<span class="line">mathquest:leaderboard:{gameId}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="configuration-cors" tabindex="-1"><a class="header-anchor" href="#configuration-cors"><span>Configuration CORS</span></a></h2><h3 id="middleware-cors" tabindex="-1"><a class="header-anchor" href="#middleware-cors"><span>Middleware CORS</span></a></h3><p>Le serveur configure CORS dans <code>src/server.ts</code> :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  origin<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span></span>
<span class="line">    <span class="token operator">?</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">FRONTEND_URL</span> <span class="token operator">||</span> <span class="token string">&#39;https://mathquest.example.com&#39;</span></span>
<span class="line">    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;http://localhost:3000&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://localhost:3001&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://localhost:3008&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  methods<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PUT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;OPTIONS&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  credentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  allowedHeaders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Authorization&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;X-Requested-With&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="configuration-des-logs" tabindex="-1"><a class="header-anchor" href="#configuration-des-logs"><span>Configuration des logs</span></a></h2><h3 id="logger-personnalise" tabindex="-1"><a class="header-anchor" href="#logger-personnalise"><span>Logger personnalisé</span></a></h3><p>Le système de logging utilise <code>winston</code> avec configuration dans <code>src/utils/logger.ts</code> :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> winston <span class="token keyword">from</span> <span class="token string">&#39;winston&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> logLevel <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOG_LEVEL</span> <span class="token operator">||</span> <span class="token string">&#39;info&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> winston<span class="token punctuation">.</span><span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  level<span class="token operator">:</span> logLevel<span class="token punctuation">,</span></span>
<span class="line">  format<span class="token operator">:</span> winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span></span>
<span class="line">    winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stack<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  defaultMeta<span class="token operator">:</span> <span class="token punctuation">{</span> service<span class="token operator">:</span> <span class="token string">&#39;mathquest&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  transports<span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">winston</span><span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      format<span class="token operator">:</span> winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span></span>
<span class="line">        winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">colorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">winston</span><span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      filename<span class="token operator">:</span> <span class="token string">&#39;logs/error.log&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      level<span class="token operator">:</span> <span class="token string">&#39;error&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">winston</span><span class="token punctuation">.</span>transports<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      filename<span class="token operator">:</span> <span class="token string">&#39;logs/combined.log&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> logger<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="configuration-des-tests" tabindex="-1"><a class="header-anchor" href="#configuration-des-tests"><span>Configuration des tests</span></a></h2><h3 id="jest-configuration" tabindex="-1"><a class="header-anchor" href="#jest-configuration"><span>Jest Configuration</span></a></h3><p>Le fichier <code>jest.config.js</code> configure les tests :</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">preset</span><span class="token operator">:</span> <span class="token string">&#39;ts-jest&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">testEnvironment</span><span class="token operator">:</span> <span class="token string">&#39;node&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">roots</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;&lt;rootDir&gt;/src&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&lt;rootDir&gt;/tests&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">testMatch</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&#39;**/__tests__/**/*.+(ts|tsx|js)&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;**/?(*.)+(spec|test).+(ts|tsx|js)&#39;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">moduleFileExtensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;ts&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;tsx&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;js&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;jsx&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;node&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">collectCoverage</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">clearMocks</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">globalSetup</span><span class="token operator">:</span> <span class="token string">&#39;&lt;rootDir&gt;/tests/support/globalSetup.ts&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">globalTeardown</span><span class="token operator">:</span> <span class="token string">&#39;&lt;rootDir&gt;/tests/support/globalTeardown.ts&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">setupFiles</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;&lt;rootDir&gt;/tests/setupTestEnv.js&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">moduleNameMapper</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&#39;^@/(.*)$&#39;</span><span class="token operator">:</span> <span class="token string">&#39;&lt;rootDir&gt;/src/$1&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;^@shared/(.*)$&#39;</span><span class="token operator">:</span> <span class="token string">&#39;&lt;rootDir&gt;/../shared/$1&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">maxConcurrency</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">maxWorkers</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">forceExit</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">testTimeout</span><span class="token operator">:</span> <span class="token number">10000</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="variables-d-environnement-par-environnement" tabindex="-1"><a class="header-anchor" href="#variables-d-environnement-par-environnement"><span>Variables d&#39;environnement par environnement</span></a></h2><h3 id="developpement" tabindex="-1"><a class="header-anchor" href="#developpement"><span>Développement</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># .env</span></span>
<span class="line"><span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development</span>
<span class="line"><span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span><span class="token string">&quot;postgresql://postgres:password@localhost:5432/mathquest_dev&quot;</span></span>
<span class="line"><span class="token assign-left variable">REDIS_URL</span><span class="token operator">=</span><span class="token string">&quot;redis://localhost:6379&quot;</span></span>
<span class="line"><span class="token assign-left variable">JWT_SECRET</span><span class="token operator">=</span><span class="token string">&quot;dev_secret_key_not_for_production&quot;</span></span>
<span class="line"><span class="token assign-left variable">LOG_LEVEL</span><span class="token operator">=</span>DEBUG</span>
<span class="line"><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3007</span></span>
<span class="line"><span class="token assign-left variable">FRONTEND_URL</span><span class="token operator">=</span><span class="token string">&quot;http://localhost:3000&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="production" tabindex="-1"><a class="header-anchor" href="#production"><span>Production</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># .env</span></span>
<span class="line"><span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production</span>
<span class="line"><span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span><span class="token string">&quot;postgresql://user:password@prod-db-host:5432/mathquest_prod&quot;</span></span>
<span class="line"><span class="token assign-left variable">REDIS_URL</span><span class="token operator">=</span><span class="token string">&quot;redis://prod-redis-host:6379&quot;</span></span>
<span class="line"><span class="token assign-left variable">JWT_SECRET</span><span class="token operator">=</span><span class="token string">&quot;production_secret_key_very_secure&quot;</span></span>
<span class="line"><span class="token assign-left variable">LOG_LEVEL</span><span class="token operator">=</span>WARN</span>
<span class="line"><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3007</span></span>
<span class="line"><span class="token assign-left variable">FRONTEND_URL</span><span class="token operator">=</span><span class="token string">&quot;https://mathquest.example.com&quot;</span></span>
<span class="line"><span class="token assign-left variable">APP_DOMAIN</span><span class="token operator">=</span><span class="token string">&quot;mathquest.example.com&quot;</span></span>
<span class="line"><span class="token assign-left variable">BREVO_API_KEY</span><span class="token operator">=</span><span class="token string">&quot;prod_brevo_key&quot;</span></span>
<span class="line"><span class="token assign-left variable">ADMIN_PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;secure_prod_admin_password&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="test" tabindex="-1"><a class="header-anchor" href="#test"><span>Test</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># .env.test</span></span>
<span class="line"><span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>test</span>
<span class="line"><span class="token assign-left variable">DATABASE_URL</span><span class="token operator">=</span><span class="token string">&quot;postgresql://postgres:password@localhost:5432/mathquest_test&quot;</span></span>
<span class="line"><span class="token assign-left variable">REDIS_URL</span><span class="token operator">=</span><span class="token string">&quot;redis://localhost:6379&quot;</span></span>
<span class="line"><span class="token assign-left variable">JWT_SECRET</span><span class="token operator">=</span><span class="token string">&quot;test_secret_key&quot;</span></span>
<span class="line"><span class="token assign-left variable">LOG_LEVEL</span><span class="token operator">=</span>ERROR</span>
<span class="line"><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3008</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="scripts-de-deploiement" tabindex="-1"><a class="header-anchor" href="#scripts-de-deploiement"><span>Scripts de déploiement</span></a></h2><h3 id="scripts-disponibles" tabindex="-1"><a class="header-anchor" href="#scripts-disponibles"><span>Scripts disponibles</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Construction complète</span></span>
<span class="line">./build-all.sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Construction pour VPS</span></span>
<span class="line">./build-vps.sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Démarrage avec PM2</span></span>
<span class="line"><span class="token function">npm</span> run pm2:start</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Redémarrage des services</span></span>
<span class="line"><span class="token function">npm</span> run pm2:restart</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Arrêt des services</span></span>
<span class="line"><span class="token function">npm</span> run pm2:stop</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Logs PM2</span></span>
<span class="line"><span class="token function">npm</span> run pm2:logs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="script-de-construction-complet" tabindex="-1"><a class="header-anchor" href="#script-de-construction-complet"><span>Script de construction complet</span></a></h3><p>Le fichier <code>build-all.sh</code> :</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Construction du backend</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Building backend...&quot;</span></span>
<span class="line"><span class="token builtin class-name">cd</span> backend</span>
<span class="line"><span class="token function">npm</span> <span class="token function">install</span></span>
<span class="line"><span class="token function">npm</span> run build</span>
<span class="line"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Construction du frontend</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Building frontend...&quot;</span></span>
<span class="line"><span class="token builtin class-name">cd</span> frontend</span>
<span class="line"><span class="token function">npm</span> <span class="token function">install</span></span>
<span class="line"><span class="token function">npm</span> run build</span>
<span class="line"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Construction de la documentation</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Building docs...&quot;</span></span>
<span class="line"><span class="token builtin class-name">cd</span> vuepress</span>
<span class="line"><span class="token function">npm</span> <span class="token function">install</span></span>
<span class="line"><span class="token function">npm</span> run build</span>
<span class="line"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">&quot;Build completed!&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="monitoring-et-metriques" tabindex="-1"><a class="header-anchor" href="#monitoring-et-metriques"><span>Monitoring et métriques</span></a></h2><h3 id="endpoints-de-sante" tabindex="-1"><a class="header-anchor" href="#endpoints-de-sante"><span>Endpoints de santé</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Santé générale</span></span>
<span class="line">GET /health</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Métriques mémoire</span></span>
<span class="line">GET /health/memory</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Métriques détaillées (authentification requise)</span></span>
<span class="line">GET /api/v1/health/metrics</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="metriques-collectees" tabindex="-1"><a class="header-anchor" href="#metriques-collectees"><span>Métriques collectées</span></a></h3><ul><li>Utilisation mémoire (heap, RSS, external)</li><li>Uptime du processus</li><li>Nombre de connexions Socket.IO actives</li><li>Latence base de données</li><li>Taux d&#39;erreur des requêtes</li><li>Métriques Redis (connexions, commandes/seconde)</li></ul><h2 id="securite-1" tabindex="-1"><a class="header-anchor" href="#securite-1"><span>Sécurité</span></a></h2><h3 id="headers-de-securite" tabindex="-1"><a class="header-anchor" href="#headers-de-securite"><span>Headers de sécurité</span></a></h3><p>Configuration des headers dans Next.js :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">async</span> <span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      source<span class="token operator">:</span> <span class="token string">&#39;/(.*)&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      headers<span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&#39;X-Frame-Options&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;DENY&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&#39;X-Content-Type-Options&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;nosniff&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&#39;Referrer-Policy&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;strict-origin-when-cross-origin&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&#39;Permissions-Policy&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;camera=(), microphone=()&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="validation-des-entrees" tabindex="-1"><a class="header-anchor" href="#validation-des-entrees"><span>Validation des entrées</span></a></h3><p>Toutes les entrées utilisateur sont validées avec Zod :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;zod&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> UserInputSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  email<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token string">&#39;Email invalide&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  password<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&#39;Mot de passe trop court&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  username<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;Nom d\\&#39;utilisateur trop court&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="migration-et-mise-a-jour" tabindex="-1"><a class="header-anchor" href="#migration-et-mise-a-jour"><span>Migration et mise à jour</span></a></h2><h3 id="variables-d-environnement-critiques" tabindex="-1"><a class="header-anchor" href="#variables-d-environnement-critiques"><span>Variables d&#39;environnement critiques</span></a></h3><p>Lors des mises à jour, vérifier ces variables :</p><ol><li><code>DATABASE_URL</code> - Peut changer avec la migration DB</li><li><code>REDIS_URL</code> - Peut changer avec le scaling</li><li><code>JWT_SECRET</code> - Ne jamais changer en production</li><li><code>BREVO_API_KEY</code> - Peut nécessiter rotation</li><li><code>ADMIN_PASSWORD</code> - À changer régulièrement</li></ol><h3 id="commandes-de-migration" tabindex="-1"><a class="header-anchor" href="#commandes-de-migration"><span>Commandes de migration</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># Migration base de données</span></span>
<span class="line"><span class="token builtin class-name">cd</span> backend</span>
<span class="line">npx prisma migrate deploy</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Génération du client Prisma</span></span>
<span class="line">npx prisma generate</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Redémarrage des services</span></span>
<span class="line"><span class="token function">npm</span> run pm2:restart</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,85)]))}const c=n(t,[["render",l]]),r=JSON.parse('{"path":"/details-techniques/configuration.html","title":"Configuration et environnement","lang":"fr-FR","frontmatter":{},"git":{"updatedTime":1758286875000,"contributors":[{"name":"alexisflesch","username":"alexisflesch","email":"alexis.flesch@gmail.com","commits":1,"url":"https://github.com/alexisflesch"}],"changelog":[{"hash":"8fbb71211cc25ed6748dfb46362eb2796047c9da","time":1758286875000,"email":"alexis.flesch@gmail.com","author":"alexisflesch","message":"updating doc"}]},"filePathRelative":"details-techniques/configuration.md"}');export{c as comp,r as data};
