# Test info

- Name: API Route Consistency >> all POST/PUT API routes should handle JSON bodies consistently
- Location: /home/aflesch/mathquest/app/tests/e2e/api-consistency.spec.ts:32:9

# Error details

```
Error: expect(received).toContain(expected) // indexOf

Expected value: 500
Received array: [400, 401]
    at /home/aflesch/mathquest/app/tests/e2e/api-consistency.spec.ts:59:32
```

# Test source

```ts
   1 | /**
   2 |  * API Route Consistency Tests
   3 |  *
   4 |  * Ens            console.log(`Response status: ${response.status()}`);
   5 |             const responseText = await response.text();
   6 |             console.log(`Response body: ${responseText.substring(0, 200)}`);
   7 |
   8 |             // All routes should return a 400 status for malformed JSON
   9 |             expect(response.status()).toBe(400);
   10 |
   11 |             // Try to parse the response as JSON (should succeed)
   12 |             const responseBody = await response.json().catch(() => null);
   13 |             expect(responseBody).not.toBeNull();PI routes follow consistent patterns for:
   14 |  * - Request body parsing (JSON vs text vs formData)
   15 |  * - Error handling
   16 |  * - Response formatting
   17 |  * - Authentication patterns
   18 |  */
   19 |
   20 | import { test, expect } from '@playwright/test';
   21 |
   22 | // Test configuration
   23 | const TEST_CONFIG = {
   24 |     baseUrl: 'http://localhost:3008',
   25 |     backendUrl: 'http://localhost:3007'
   26 | };
   27 |
   28 | /**
   29 |  * Test that all API routes handle JSON request bodies consistently
   30 |  */
   31 | test.describe('API Route Consistency', () => {
   32 |     test('all POST/PUT API routes should handle JSON bodies consistently', async ({ page }) => {
   33 |         // Test various API endpoints with malformed JSON to ensure they handle parsing errors consistently
   34 |
   35 |         const apiEndpoints = [
   36 |             { path: '/api/games', method: 'POST', body: '{invalid json' },
   37 |             { path: '/api/games/TEST123/join', method: 'POST', body: '{invalid json' },
   38 |             { path: '/api/games/TEST123/status', method: 'PUT', body: '{invalid json' },
   39 |             { path: '/api/auth/register', method: 'POST', body: '{invalid json' },
   40 |             { path: '/api/auth/universal-login', method: 'POST', body: '{invalid json' },
   41 |             { path: '/api/game-templates', method: 'POST', body: '{invalid json' },
   42 |         ];
   43 |
   44 |         for (const endpoint of apiEndpoints) {
   45 |             console.log(`Testing endpoint: ${endpoint.path}`);
   46 |             const response = await page.request.fetch(endpoint.path, {
   47 |                 method: endpoint.method,
   48 |                 headers: {
   49 |                     'Content-Type': 'application/json',
   50 |                 },
   51 |                 data: endpoint.body
   52 |             });
   53 |
   54 |             console.log(`Response status: ${response.status()}`);
   55 |             const responseText = await response.text();
   56 |             console.log(`Response body: ${responseText.substring(0, 200)}`);
   57 |
   58 |             // Routes should return either 400 (malformed JSON) or 401 (auth required before JSON validation)
>  59 |             expect([400, 401]).toContain(response.status());
      |                                ^ Error: expect(received).toContain(expected) // indexOf
   60 |
   61 |             // Try to parse the response as JSON (should succeed)
   62 |             const parsedResponseBody = await response.json().catch(() => null);
   63 |             expect(parsedResponseBody).not.toBeNull();
   64 |
   65 |             // Should have consistent error structure
   66 |             expect(parsedResponseBody).toHaveProperty('error');
   67 |             expect(typeof parsedResponseBody.error).toBe('string');
   68 |         }
   69 |     });
   70 |
   71 |     test('all API routes should handle empty request bodies appropriately', async ({ page }) => {
   72 |         const apiEndpoints = [
   73 |             { path: '/api/games', method: 'POST' },
   74 |             { path: '/api/games/TEST123/join', method: 'POST' },
   75 |             { path: '/api/auth/register', method: 'POST' },
   76 |             { path: '/api/auth/universal-login', method: 'POST' },
   77 |         ];
   78 |
   79 |         for (const endpoint of apiEndpoints) {
   80 |             const response = await page.request.fetch(endpoint.path, {
   81 |                 method: endpoint.method,
   82 |                 headers: {
   83 |                     'Content-Type': 'application/json',
   84 |                 },
   85 |                 data: ''
   86 |             });
   87 |
   88 |             // Should return 400 for empty JSON body
   89 |             expect([400, 422]).toContain(response.status());
   90 |         }
   91 |     });
   92 |
   93 |     test('API routes should consistently validate Content-Type headers', async ({ page }) => {
   94 |         // Test that routes expecting JSON properly validate Content-Type
   95 |         const endpoints = [
   96 |             '/api/games',
   97 |             '/api/games/TEST123/join',
   98 |             '/api/auth/register',
   99 |         ];
  100 |
  101 |         for (const endpoint of endpoints) {
  102 |             // Test with missing Content-Type
  103 |             const response1 = await page.request.post(endpoint, {
  104 |                 data: JSON.stringify({ test: 'data' })
  105 |             });
  106 |
  107 |             // Should still work (most APIs are forgiving)
  108 |             expect([200, 201, 400, 401, 422]).toContain(response1.status());
  109 |
  110 |             // Test with wrong Content-Type
  111 |             const response2 = await page.request.post(endpoint, {
  112 |                 headers: {
  113 |                     'Content-Type': 'text/plain',
  114 |                 },
  115 |                 data: JSON.stringify({ test: 'data' })
  116 |             });
  117 |
  118 |             // Should still work or return validation error
  119 |             expect([200, 201, 400, 401, 422]).toContain(response2.status());
  120 |         }
  121 |     });
  122 | });
  123 |
  124 | /**
  125 |  * Test that API routes handle authentication consistently
  126 |  */
  127 | test.describe('API Authentication Consistency', () => {
  128 |     test('unauthenticated requests should return consistent error format', async ({ page }) => {
  129 |         const protectedEndpoints = [
  130 |             { path: '/api/games', method: 'POST' },
  131 |             { path: '/api/games/TEST123/status', method: 'PUT' },
  132 |             { path: '/api/game-templates', method: 'POST' },
  133 |         ];
  134 |
  135 |         for (const endpoint of protectedEndpoints) {
  136 |             const response = await page.request.fetch(endpoint.path, {
  137 |                 method: endpoint.method,
  138 |                 headers: {
  139 |                     'Content-Type': 'application/json',
  140 |                 },
  141 |                 data: JSON.stringify({ test: 'data' })
  142 |             });
  143 |
  144 |             // Should return 401 for unauthenticated requests
  145 |             expect(response.status()).toBe(401);
  146 |
  147 |             const responseBody = await response.json().catch(() => null);
  148 |             expect(responseBody).toHaveProperty('error');
  149 |             expect(typeof responseBody.error).toBe('string');
  150 |         }
  151 |     });
  152 | });
  153 |
  154 | /**
  155 |  * Test that API routes handle errors consistently
  156 |  */
  157 | test.describe('API Error Handling Consistency', () => {
  158 |     test('all API routes should return JSON errors for client errors', async ({ page }) => {
  159 |         // Test various error scenarios
```