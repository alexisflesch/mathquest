# Test info

- Name: Tournament Deferred Mode E2E >> Deferred Tournament: Students join and complete at different times
- Location: /home/aflesch/mathquest/app/tests/e2e/tournament-deferred.spec.ts:41:9

# Error details

```
Error: Timed out 3000ms waiting for expect(locator).toHaveURL(expected)

Locator: locator(':root')
Expected string: "http://localhost:3008/teacher/home"
Received string: "http://localhost:3008/"
Call log:
  - expect.toHaveURL with timeout 3000ms
  - waiting for locator(':root')
    7 Ã— locator resolved to <html lang="fr" data-theme="light" class="__className_f367f3">â€¦</html>
      - unexpected value "http://localhost:3008/"

    at /home/aflesch/mathquest/app/tests/e2e/tournament-deferred.spec.ts:58:35
```

# Page snapshot

```yaml
- alert: Kutsum
- complementary:
  - button "RÃ©duire le menu"
  - text: rÃ©gis ðŸ´
  - navigation:
    - link "Accueil":
      - /url: /
    - link "EntraÃ®nement libre":
      - /url: /student/create-game?training=true
    - link "Rejoindre une activitÃ©":
      - /url: /student/join
    - link "CrÃ©er un tournoi":
      - /url: /student/create-game
    - link "Historique":
      - /url: /my-tournaments
    - text: Enseignant
    - link "Mes activitÃ©s":
      - /url: /teacher/games
    - link "CrÃ©er une activitÃ©":
      - /url: /teacher/games/new
    - link "Ã‰diter des questions":
      - /url: /teacher/questions/edit
    - text: Compte
    - link "Mon profil":
      - /url: /profile
  - button "Passer en mode clair": ThÃ¨me systÃ¨me
  - button "DÃ©connexion"
- main:
  - img "Kutsum logo"
  - heading "Kutsum" [level=1]
  - paragraph: Keep Up The Speed, Unleash Mastery !
  - paragraph: Bonjour rÃ©gis ðŸ‘‹, ravi de vous revoir !
  - paragraph: "Utilisez le menu Ã  gauche pour naviguer dans l'application. Vous pouvez :"
  - list:
    - listitem:
      - strong: GÃ©rer vos activitÃ©s existantes
      - text: ": gÃ©rer vos sessions et tournois existants"
    - listitem:
      - strong: CrÃ©er de nouvelles activitÃ©s
      - text: ": prÃ©parer de nouveaux quiz ou tournois pour vos Ã©lÃ¨ves en piochant dans la base de donnÃ©es"
  - paragraph: "Pour en savoir plus :"
  - link "Site du projet Kutsum":
    - /url: https://kutsum.org
    - text: Site du projet
  - link "Documentation externe":
    - /url: https://docs.kutsum.org
    - text: Documentation
  - link "Contribuer sur GitHub":
    - /url: https://github.com/alexisflesch/mathquest
    - text: Contribuer
  - strong: "âš ï¸ En dÃ©veloppement :"
  - text: le service peut Ãªtre interrompu pour mise Ã  jour.
```

# Test source

```ts
   1 | import { test, expect, Page } from '@playwright/test';
   2 | import { TestDataHelper, LoginHelper, SocketHelper } from './helpers/test-helpers';
   3 |
   4 | test.describe('Tournament Deferred Mode E2E', () => {
   5 |     let teacherPage: Page;
   6 |     let batchOnePages: Page[] = [];
   7 |     let batchTwoPages: Page[] = [];
   8 |     let testData: any;
   9 |
   10 |     test.beforeAll(async ({ browser }) => {
   11 |         // Create separate browser contexts
   12 |         const teacherContext = await browser.newContext();
   13 |         teacherPage = await teacherContext.newPage();
   14 |
   15 |         // Create pages for first batch of students (early joiners)
   16 |         for (let i = 0; i < 3; i++) {
   17 |             const studentContext = await browser.newContext();
   18 |             const studentPage = await studentContext.newPage();
   19 |             batchOnePages.push(studentPage);
   20 |         }
   21 |
   22 |         // Create pages for second batch of students (later joiners)
   23 |         for (let i = 0; i < 2; i++) {
   24 |             const studentContext = await browser.newContext();
   25 |             const studentPage = await studentContext.newPage();
   26 |             batchTwoPages.push(studentPage);
   27 |         }
   28 |
   29 |         // Generate test data
   30 |         const dataHelper = new TestDataHelper(teacherPage);
   31 |         testData = dataHelper.generateTestData('deferred_tournament_e2e');
   32 |     });
   33 |
   34 |     test.afterAll(async () => {
   35 |         await teacherPage?.close();
   36 |         for (const page of [...batchOnePages, ...batchTwoPages]) {
   37 |             await page?.close();
   38 |         }
   39 |     });
   40 |
   41 |     test('Deferred Tournament: Students join and complete at different times', async () => {
   42 |         const dataHelper = new TestDataHelper(teacherPage);
   43 |         const teacherLogin = new LoginHelper(teacherPage);
   44 |         const teacherSocket = new SocketHelper(teacherPage);
   45 |
   46 |         // Step 1: Create teacher account and login
   47 |         await dataHelper.createTeacher({
   48 |             username: testData.username,
   49 |             email: testData.email,
   50 |             password: testData.password
   51 |         });
   52 |
   53 |         await teacherLogin.loginAsTeacher({
   54 |             email: testData.email,
   55 |             password: testData.password
   56 |         });
   57 |
>  58 |         await expect(teacherPage).toHaveURL('/teacher/home');
      |                                   ^ Error: Timed out 3000ms waiting for expect(locator).toHaveURL(expected)
   59 |
   60 |         // Step 2: Create tournament in deferred mode with duration/deadline
   61 |         await teacherPage.click('[data-testid="create-tournament-button"]');
   62 |         await teacherPage.fill('[data-testid="tournament-name-input"]', testData.tournamentName);
   63 |
   64 |         // Enable deferred mode
   65 |         await teacherPage.check('[data-testid="deferred-mode-checkbox"]');
   66 |
   67 |         // Set tournament configuration for deferred mode
   68 |         await teacherPage.selectOption('[data-testid="tournament-theme"]', 'arithmetic');
   69 |         await teacherPage.selectOption('[data-testid="tournament-difficulty"]', 'easy');
   70 |         await teacherPage.fill('[data-testid="tournament-questions-count"]', '4');
   71 |
   72 |         // Set tournament duration (e.g., 2 hours from now)
   73 |         const futureTime = new Date(Date.now() + 2 * 60 * 60 * 1000);
   74 |         await teacherPage.fill('[data-testid="tournament-deadline"]', futureTime.toISOString().slice(0, 16));
   75 |
   76 |         await teacherPage.click('[data-testid="create-tournament-confirm"]');
   77 |
   78 |         // Step 3: Start deferred tournament
   79 |         await teacherPage.click('[data-testid="start-deferred-tournament-button"]');
   80 |         await teacherSocket.waitForSocketConnection();
   81 |
   82 |         const accessCode = await teacherPage.locator('[data-testid="access-code"]').textContent();
   83 |         expect(accessCode).toBeTruthy();
   84 |         expect(accessCode).toMatch(/^\d{6}$/);
   85 |
   86 |         // Verify deferred mode indicators
   87 |         await expect(teacherPage.locator('[data-testid="deferred-mode-active"]')).toBeVisible();
   88 |         await expect(teacherPage.locator('[data-testid="tournament-deadline-display"]')).toBeVisible();
   89 |
   90 |         // Step 4: First batch of students join and complete tournament
   91 |         const batchOneHelpers = [];
   92 |         for (let i = 0; i < batchOnePages.length; i++) {
   93 |             const studentPage = batchOnePages[i];
   94 |             const studentSocket = new SocketHelper(studentPage);
   95 |
   96 |             batchOneHelpers.push({ page: studentPage, socket: studentSocket });
   97 |
   98 |             // Student joins deferred tournament
   99 |             await studentPage.goto('/student/join');
  100 |             await studentPage.fill('[data-testid="access-code-input"]', accessCode!);
  101 |             await studentPage.fill('[data-testid="username-input"]', `${testData.username}_batch1_student${i + 1}`);
  102 |             await studentPage.click('[data-testid="join-tournament-button"]');
  103 |             await studentSocket.waitForSocketConnection();
  104 |
  105 |             // Verify deferred mode interface
  106 |             await expect(studentPage.locator('[data-testid="deferred-tournament-start"]')).toBeVisible();
  107 |             await expect(studentPage.locator('[data-testid="tournament-deadline-timer"]')).toBeVisible();
  108 |         }
  109 |
  110 |         // Students from batch 1 start their individual tournaments
  111 |         for (let i = 0; i < batchOneHelpers.length; i++) {
  112 |             const helper = batchOneHelpers[i];
  113 |
  114 |             await helper.page.click('[data-testid="start-my-tournament-button"]');
  115 |
  116 |             // Complete tournament questions at their own pace
  117 |             for (let questionIndex = 0; questionIndex < 4; questionIndex++) {
  118 |                 await expect(helper.page.locator('[data-testid="deferred-question"]')).toBeVisible();
  119 |
  120 |                 // Answer question (with some variety)
  121 |                 const answerIndex = (i + questionIndex) % 4;
  122 |                 await helper.page.click(`[data-testid="answer-option-${answerIndex}"]`);
  123 |                 await helper.page.click('[data-testid="submit-answer-button"]');
  124 |
  125 |                 // Wait for next question or completion
  126 |                 if (questionIndex < 3) {
  127 |                     await helper.page.click('[data-testid="next-question-button"]');
  128 |                 }
  129 |             }
  130 |
  131 |             // Verify individual completion
  132 |             await expect(helper.page.locator('[data-testid="deferred-tournament-complete"]')).toBeVisible();
  133 |             await expect(helper.page.locator('[data-testid="my-score-display"]')).toBeVisible();
  134 |         }
  135 |
  136 |         // Step 5: Verify teacher can see partial leaderboard with batch 1 completions
  137 |         await expect(teacherPage.locator('[data-testid="deferred-leaderboard"]')).toBeVisible();
  138 |         await expect(teacherPage.locator('[data-testid="completed-count"]')).toContainText('3');
  139 |
  140 |         for (let i = 0; i < batchOneHelpers.length; i++) {
  141 |             const studentName = `${testData.username}_batch1_student${i + 1}`;
  142 |             await expect(teacherPage.locator('[data-testid="deferred-leaderboard"]')).toContainText(studentName);
  143 |         }
  144 |
  145 |         // Step 6: Second batch of students join later (while tournament still active)
  146 |         // Simulate some time passing
  147 |         await teacherPage.waitForTimeout(2000);
  148 |
  149 |         const batchTwoHelpers = [];
  150 |         for (let i = 0; i < batchTwoPages.length; i++) {
  151 |             const studentPage = batchTwoPages[i];
  152 |             const studentSocket = new SocketHelper(studentPage);
  153 |
  154 |             batchTwoHelpers.push({ page: studentPage, socket: studentSocket });
  155 |
  156 |             // Later students join the same tournament
  157 |             await studentPage.goto('/student/join');
  158 |             await studentPage.fill('[data-testid="access-code-input"]', accessCode!);
```