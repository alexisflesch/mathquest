
> backend@1.0.0 test
> jest lobbyDebug.test.ts

Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma

✔ Generated Prisma Client (v6.7.0) to ./src/db/generated/client in 168ms

Start by importing your Prisma Client (See: https://pris.ly/d/importing-client)

Tip: Interested in query caching in just a few lines of code? Try Accelerate today! https://pris.ly/tip-3-accelerate

Test setup complete, using port 5576
Database URL: postgresql://postgre:Phuf0pohooFee8auohFahk7vChae4Iv0wiem5voT@localhost:5432/mathquest_test
Redis URL: redis://localhost:6379
Cleaning test database...
Database cleaned successfully
Inserted default test questions.
Seeded integration teacher, template, questions, and game instance.
  console.log
    [2025-06-09 13:50:51.987] [32mINFO [0m [Server] Successfully connected to Redis.

      at log (src/utils/logger.ts:102:21)

  console.log
    🔧 Starting debug test...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:130:17)

  console.log
    🔌 Connecting socket...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:145:17)

  console.log
    [2025-06-09 13:50:52.360] [33mWARN [0m [TestSocketAuth] {
      "tokenRole": "STUDENT",
      "queryRole": "player",
      "socketId": "F9pFkNDnVijz2CW-AAAB"
    } Role mismatch between JWT and query parameter in testSetup.ts. Using token role.

      at log (src/utils/logger.ts:102:21)

  console.log
    [2025-06-09 13:50:52.366] [32mINFO [0m [ConnectionHandlers] {
      "socketId": "F9pFkNDnVijz2CW-AAAB",
      "user": {
        "id": "player-123",
        "userId": "player-123",
        "username": "Test Player",
        "role": "STUDENT"
      },
      "address": "::ffff:127.0.0.1"
    } New socket connection established

      at log (src/utils/logger.ts:102:21)

  console.log
    ✅ Received event: connect undefined

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:37:21)

  console.log
    📡 Received event: connection_established [
      {
        socketId: 'F9pFkNDnVijz2CW-AAAB',
        timestamp: '2025-06-09T11:50:52.370Z',
        user: { role: 'STUDENT', userId: 'player-123', username: 'Test Player' }
      }
    ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    ✅ Socket connected

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:148:17)

  console.log
    🏠 Joining lobby...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:151:17)

  console.log
    📤 Sent join_lobby event

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:159:17)

  console.log
    [2025-06-09 13:50:53.442] [32mINFO [0m [LobbyHandler] {
      "accessCode": "TEST123",
      "userId": "player-123",
      "username": "Test Player",
      "socketId": "F9pFkNDnVijz2CW-AAAB"
    } Player joining lobby

      at log (src/utils/logger.ts:102:21)

  console.log
    📡 Received event: room_joined [ { room: 'lobby_TEST123', timestamp: '2025-06-09T11:50:53.459Z' } ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    📡 Received event: participants_list [
      {
        participants: [ [Object] ],
        gameId: '0c83e1ba-2449-4121-94fa-ef0083d2af70',
        gameName: 'Test Game Debug'
      }
    ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    ✅ Received event: participants_list {
      "participants": [
        {
          "id": "F9pFkNDnVijz2CW-AAAB",
          "userId": "player-123",
          "username": "Test Player",
          "avatarEmoji": "avatar.jpg",
          "joinedAt": 1749469853459
        }
      ],
      "gameId": "0c83e1ba-2449-4121-94fa-ef0083d2af70",
      "gameName": "Test Game Debug"
    }

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:37:21)

  console.log
    ✅ Got participants list: {
      participants: [
        {
          id: 'F9pFkNDnVijz2CW-AAAB',
          userId: 'player-123',
          username: 'Test Player',
          avatarEmoji: 'avatar.jpg',
          joinedAt: 1749469853459
        }
      ],
      gameId: '0c83e1ba-2449-4121-94fa-ef0083d2af70',
      gameName: 'Test Game Debug'
    }

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:161:17)

  console.log
    🔍 Checking participantsResponse is defined...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:163:17)

  console.log
    ✅ participantsResponse is defined

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:165:17)

  console.log
    🔍 Checking participantsResponse.participants is defined...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:167:17)

  console.log
    ✅ participantsResponse.participants is defined

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:169:17)

  console.log
    🔍 Checking participants length is 1...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:171:17)

  console.log
    Actual length: 1

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:172:17)

  console.log
    ✅ participants length is correct

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:174:17)

  console.log
    🔍 Checking first participant username...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:176:17)

  console.log
    Actual username: Test Player

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:177:17)

  console.log
    ✅ username is correct

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:179:17)

  console.log
    🚪 Leaving lobby...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:182:17)

  console.log
    📤 Sent leave_lobby event

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:185:17)

  console.log
    [2025-06-09 13:50:53.498] [32mINFO [0m [ParticipantCountUtils] {
      "accessCode": "TEST123",
      "gameId": "0c83e1ba-2449-4121-94fa-ef0083d2af70",
      "lobbyCount": 1,
      "gameCount": 0,
      "totalCount": 1
    } Emitting participant count to dashboard

      at log (src/utils/logger.ts:102:21)

  console.log
    [2025-06-09 13:50:53.509] [32mINFO [0m [LobbyHandler] {
      "accessCode": "TEST123",
      "socketId": "F9pFkNDnVijz2CW-AAAB"
    } Player leaving lobby

      at log (src/utils/logger.ts:102:21)

  console.log
    📡 Received event: room_left [ { room: 'lobby_TEST123', timestamp: '2025-06-09T11:50:53.513Z' } ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    ✅ Received event: room_left {
      "room": "lobby_TEST123",
      "timestamp": "2025-06-09T11:50:53.513Z"
    }

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:37:21)

  console.log
    ✅ Got room_left event

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:189:17)

  console.log
    📋 Getting updated participants list...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:192:17)

  console.log
    📤 Sent get_participants event

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:195:17)

  console.log
    📡 Received event: participants_list [ { participants: [] } ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    ✅ Received event: participants_list {
      "participants": []
    }

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:37:21)

  console.log
    📡 Received event: room_left [ { accessCode: 'TEST123' } ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    📡 Received event: room_joined [ { room: 'lobby_TEST123', timestamp: '2025-06-09T11:50:53.531Z' } ]

      at Socket.<anonymous> (tests/integration/lobbyDebug.test.ts:141:21)

  console.log
    ✅ Got updated participants list: { participants: [] }

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:199:17)

  console.log
    🔍 Checking updatedParticipantsResponse is defined...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:201:17)

  console.log
    ✅ updatedParticipantsResponse is defined

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:203:17)

  console.log
    🔍 Checking updatedParticipantsResponse.participants is defined...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:205:17)

  console.log
    ✅ updatedParticipantsResponse.participants is defined

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:207:17)

  console.log
    🔍 Checking updated participants length is 0...

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:209:17)

  console.log
    Actual updated length: 0

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:210:17)

  console.log
    ✅ updated participants length is correct

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:212:17)

  console.log
    🔧 Debug test completed successfully!

      at Object.<anonymous> (tests/integration/lobbyDebug.test.ts:214:17)

  console.log
    [2025-06-09 13:50:53.576] [32mINFO [0m [ParticipantCountUtils] {
      "accessCode": "TEST123",
      "gameId": "0c83e1ba-2449-4121-94fa-ef0083d2af70",
      "lobbyCount": 1,
      "gameCount": 0,
      "totalCount": 1
    } Emitting participant count to dashboard

      at log (src/utils/logger.ts:102:21)

  console.log
    [2025-06-09 13:50:53.580] [32mINFO [0m [LobbyHandler] {
      "accessCode": "TEST123",
      "socketId": "F9pFkNDnVijz2CW-AAAB"
    } Socket disconnecting from lobby

      at log (src/utils/logger.ts:102:21)

  console.log
    [2025-06-09 13:50:53.583] [32mINFO [0m [DisconnectHandler] {
      "socketId": "F9pFkNDnVijz2CW-AAAB",
      "reason": "client namespace disconnect"
    } Client disconnected

      at log (src/utils/logger.ts:102:21)

  console.log
    [2025-06-09 13:50:53.586] [33mWARN [0m [DisconnectHandler] {
      "socketId": "F9pFkNDnVijz2CW-AAAB",
      "reason": "client namespace disconnect"
    } Disconnected socket had no userId or accessCode in socket.data. Cannot process participant update.

      at log (src/utils/logger.ts:102:21)

  console.log
    [2025-06-09 13:50:53.630] [32mINFO [0m [ParticipantCountUtils] {
      "accessCode": "TEST123",
      "gameId": "0c83e1ba-2449-4121-94fa-ef0083d2af70",
      "lobbyCount": 0,
      "gameCount": 0,
      "totalCount": 0
    } Emitting participant count to dashboard

      at log (src/utils/logger.ts:102:21)

FAIL tests/integration/lobbyDebug.test.ts (8.169 s)
  Lobby Handler Debug
    ✕ Debug: Player can join and leave a lobby (1283 ms)

  ● Lobby Handler Debug › Debug: Player can join and leave a lobby





-------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------
File                                 | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                 
-------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------
All files                            |   27.82 |    14.15 |   22.14 |   27.68 |                                                                                                                                                   
 src/config                          |      75 |        0 |      50 |      75 |                                                                                                                                                   
  redis.ts                           |      75 |        0 |      50 |      75 | 7-8,23                                                                                                                                            
 src/core                            |     7.3 |        0 |       0 |     7.8 |                                                                                                                                                   
  gameStateService.ts                |     7.3 |        0 |       0 |     7.8 | 44-117,129-202,214-289,305-368,379-407,419-544,556-569                                                                                            
 src/core/services                   |    4.12 |        0 |       0 |    4.34 |                                                                                                                                                   
  gameInstanceService.ts             |    4.12 |        0 |       0 |    4.34 | 41-465                                                                                                                                            
 src/db                              |     100 |      100 |     100 |     100 |                                                                                                                                                   
  prisma.ts                          |     100 |      100 |     100 |     100 |                                                                                                                                                   
 src/db/generated/client             |   92.06 |       50 |       0 |   92.06 |                                                                                                                                                   
  index.js                           |   92.06 |       50 |       0 |   92.06 | 295-305                                                                                                                                           
 src/db/generated/client/runtime     |   28.44 |    15.51 |   21.91 |      58 |                                                                                                                                                   
  library.js                         |   28.44 |    15.51 |   21.91 |      58 | 14,18-22,25-27,38-60,68,72-104,126-129                                                                                                            
 src/sockets                         |    43.9 |        0 |   14.28 |    43.9 |                                                                                                                                                   
  index.ts                           |    43.9 |        0 |   14.28 |    43.9 | 23-61,68-74,83,93-98,110-112                                                                                                                      
 src/sockets/handlers                |   27.22 |     6.56 |   21.51 |   28.27 |                                                                                                                                                   
  connectionHandlers.ts              |    91.3 |       50 |     100 |    90.9 | 25-26                                                                                                                                             
  disconnectHandler.ts               |   30.55 |       20 |     100 |   30.55 | 29-80                                                                                                                                             
  gameHandler.ts                     |   83.33 |      100 |     100 |   83.33 | 15                                                                                                                                                
  lobbyHandler.ts                    |   57.92 |       25 |    37.5 |   59.32 | 64-69,74-79,84-95,101,108-120,172-173,200-201,229,234-236,244-245,262,286-290,296,301-303,311-313,327-328,350,361,366-368,376-377,391-401,412-466 
  projectorHandler.ts                |      20 |        0 |       0 |      20 | 18-55,62-78                                                                                                                                       
  sharedAnswers.ts                   |   44.44 |        0 |       0 |   57.14 | 16-18                                                                                                                                             
  sharedGameFlow.ts                  |    8.16 |        0 |       0 |    8.69 | 35-98                                                                                                                                             
  sharedLeaderboard.ts               |      40 |        0 |       0 |   46.15 | 17-28,38                                                                                                                                          
  sharedLiveHandler.ts               |    5.86 |        0 |    4.16 |    6.22 | 32-296,303-475,484-489,501                                                                                                                        
  sharedScore.ts                     |      30 |        0 |       0 |    37.5 | 16-20                                                                                                                                             
  teacherControlHandler.ts           |      75 |      100 |       0 |      75 | 11                                                                                                                                                
  tournamentHandler.ts               |   12.98 |        0 |       0 |   13.33 | 25-178                                                                                                                                            
 src/sockets/handlers/game           |    4.65 |        0 |       0 |    4.87 |                                                                                                                                                   
  index.ts                           |    4.65 |        0 |       0 |    4.87 | 3-10,13-98                                                                                                                                        
 src/sockets/handlers/teacherControl |   11.45 |        0 |       0 |   11.47 |                                                                                                                                                   
  disconnect.ts                      |   33.33 |        0 |       0 |   33.33 | 10-27                                                                                                                                             
  endGame.ts                         |   13.15 |        0 |       0 |   13.15 | 12-113                                                                                                                                            
  helpers.ts                         |   13.43 |        0 |       0 |   13.43 | 19-47,61-156,164-191                                                                                                                              
  index.ts                           |   57.89 |      100 |       0 |   57.89 | 19-40                                                                                                                                             
  joinDashboard.ts                   |    9.75 |        0 |       0 |    9.75 | 14-232                                                                                                                                            
  lockAnswers.ts                     |   13.51 |        0 |       0 |   13.51 | 12-102                                                                                                                                            
  pauseTimer.ts                      |    7.69 |        0 |       0 |    7.69 | 13-208                                                                                                                                            
  setQuestion.ts                     |    6.38 |        0 |       0 |    6.45 | 12-229                                                                                                                                            
  startTimer.ts                      |    7.69 |        0 |       0 |    7.69 | 13-203                                                                                                                                            
  timerAction.ts                     |    7.35 |        0 |       0 |    7.35 | 12-164                                                                                                                                            
 src/sockets/handlers/tournament     |      75 |      100 |       0 |      75 |                                                                                                                                                   
  index.ts                           |      75 |      100 |       0 |      75 | 6                                                                                                                                                 
 src/sockets/middleware              |   13.95 |     2.22 |       0 |    11.9 |                                                                                                                                                   
  socketAuth.ts                      |   13.95 |     2.22 |       0 |    11.9 | 19-142                                                                                                                                            
 src/sockets/utils                   |   51.16 |    30.43 |    37.5 |   52.38 |                                                                                                                                                   
  participantCountUtils.ts           |   51.42 |    36.36 |      50 |   51.42 | 20-21,32-33,70,89-121                                                                                                                             
  roomUtils.ts                       |   50.98 |       25 |   33.33 |   53.06 | 50-58,91-99,109-123,133-142,161-182                                                                                                               
 src/utils                           |   85.71 |       48 |    90.9 |   85.41 |                                                                                                                                                   
  logger.ts                          |   85.71 |       48 |    90.9 |   85.41 | 39,90,96,108,111-112,120                                                                                                                          
 tests                               |   81.48 |    65.21 |      80 |   81.81 |                                                                                                                                                   
  testSetup.ts                       |   81.48 |    65.21 |      80 |   81.81 | 69-70,89-105,168-169,178,183                                                                                                                      
 tests/helpers                       |     100 |       50 |     100 |     100 |                                                                                                                                                   
  jwt.ts                             |     100 |       50 |     100 |     100 | 3-5                                                                                                                                               
-------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 total
Snapshots:   0 total
Time:        8.868 s
Ran all test suites matching /lobbyDebug.test.ts/i.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
