<!doctype html>
<html lang="fr-FR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.23" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/mathquest/favicon.ico"><link rel="stylesheet" href="/mathquest/styles/screenshots.css"><title>Services backend | MathQuest</title><meta name="description" content="Alternative libre et open source à Kahoot, pour les enseignants et leurs élèves.">
    <link rel="preload" href="/mathquest/assets/style-Dkmw-xJK.css" as="style"><link rel="stylesheet" href="/mathquest/assets/style-Dkmw-xJK.css">
    <link rel="modulepreload" href="/mathquest/assets/app-DoDG4mLI.js"><link rel="modulepreload" href="/mathquest/assets/backend-services.html-Bn7Sl0dY.js">
    <link rel="prefetch" href="/mathquest/assets/index.html-DVgZZIvh.js" as="script"><link rel="prefetch" href="/mathquest/assets/index.html-D41YBSyI.js" as="script"><link rel="prefetch" href="/mathquest/assets/api.html-DuEObc8p.js" as="script"><link rel="prefetch" href="/mathquest/assets/architecture.html-u6XaedTl.js" as="script"><link rel="prefetch" href="/mathquest/assets/configuration.html-CK6wnHSc.js" as="script"><link rel="prefetch" href="/mathquest/assets/database.html-Cst-518d.js" as="script"><link rel="prefetch" href="/mathquest/assets/deployement.html-DyDpUuyd.js" as="script"><link rel="prefetch" href="/mathquest/assets/performance-monitoring.html-rC33no4g.js" as="script"><link rel="prefetch" href="/mathquest/assets/scoring.html-Bcr7KETl.js" as="script"><link rel="prefetch" href="/mathquest/assets/security.html-CnxCz1Mf.js" as="script"><link rel="prefetch" href="/mathquest/assets/tests.html-hRJAedr5.js" as="script"><link rel="prefetch" href="/mathquest/assets/troubleshooting.html-CcGeBJgq.js" as="script"><link rel="prefetch" href="/mathquest/assets/index.html-BOckdlIK.js" as="script"><link rel="prefetch" href="/mathquest/assets/index.html-C5kHWhGv.js" as="script"><link rel="prefetch" href="/mathquest/assets/contribuer.html-BwIMJqK-.js" as="script"><link rel="prefetch" href="/mathquest/assets/index.html-XR6uVX9n.js" as="script"><link rel="prefetch" href="/mathquest/assets/entrainement.html-ruDYf3W6.js" as="script"><link rel="prefetch" href="/mathquest/assets/quiz.html-Jk8e0nUz.js" as="script"><link rel="prefetch" href="/mathquest/assets/tournoi.html-DqqXOLYd.js" as="script"><link rel="prefetch" href="/mathquest/assets/404.html-DZLuBRi1.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/mathquest/"><img class="vp-site-logo" src="/mathquest/assets/logo.svg" alt="MathQuest"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">MathQuest</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/" aria-label="Accueil"><!--[--><!--[--><!--]--><!--]-->Accueil<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/utilisation/" aria-label="Utilisation de l&#39;appli"><!--[--><!--[--><!--]--><!--]-->Utilisation de l&#39;appli<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/questions-yaml/" aria-label="Écriture de questions"><!--[--><!--[--><!--]--><!--]-->Écriture de questions<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/installation/" aria-label="Installation"><!--[--><!--[--><!--]--><!--]-->Installation<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/mathquest/details-techniques/" aria-label="Détails techniques"><!--[--><!--[--><!--]--><!--]-->Détails techniques<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/" aria-label="Accueil"><!--[--><!--[--><!--]--><!--]-->Accueil<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/utilisation/" aria-label="Utilisation de l&#39;appli"><!--[--><!--[--><!--]--><!--]-->Utilisation de l&#39;appli<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/questions-yaml/" aria-label="Écriture de questions"><!--[--><!--[--><!--]--><!--]-->Écriture de questions<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/mathquest/installation/" aria-label="Installation"><!--[--><!--[--><!--]--><!--]-->Installation<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/mathquest/details-techniques/" aria-label="Détails techniques"><!--[--><!--[--><!--]--><!--]-->Détails techniques<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">Détails techniques (utilisateurs avancés seulement) <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item" href="/mathquest/details-techniques/" aria-label="Détails techniques (utilisateurs avancés seulement)"><!--[--><!--[--><!--]--><!--]-->Détails techniques (utilisateurs avancés seulement)<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/architecture.html" aria-label="Architecture générale"><!--[--><!--[--><!--]--><!--]-->Architecture générale<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/database.html" aria-label="Base de données"><!--[--><!--[--><!--]--><!--]-->Base de données<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/scoring.html" aria-label="Système de scoring"><!--[--><!--[--><!--]--><!--]-->Système de scoring<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/mathquest/details-techniques/backend-services.html" aria-label="Services backend"><!--[--><!--[--><!--]--><!--]-->Services backend<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/api.html" aria-label="API REST"><!--[--><!--[--><!--]--><!--]-->API REST<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/configuration.html" aria-label="Configuration et environnement"><!--[--><!--[--><!--]--><!--]-->Configuration et environnement<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/tests.html" aria-label="Tests et qualité"><!--[--><!--[--><!--]--><!--]-->Tests et qualité<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/deployement.html" aria-label="Déploiement et DevOps"><!--[--><!--[--><!--]--><!--]-->Déploiement et DevOps<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/security.html" aria-label="Security Documentation"><!--[--><!--[--><!--]--><!--]-->Security Documentation<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/performance-monitoring.html" aria-label="Performance &amp; Monitoring"><!--[--><!--[--><!--]--><!--]-->Performance &amp; Monitoring<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/mathquest/details-techniques/troubleshooting.html" aria-label="Troubleshooting Guide"><!--[--><!--[--><!--]--><!--]-->Troubleshooting Guide<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="services-backend" tabindex="-1"><a class="header-anchor" href="#services-backend"><span>Services backend</span></a></h1><h2 id="vue-d-ensemble-des-services" tabindex="-1"><a class="header-anchor" href="#vue-d-ensemble-des-services"><span>Vue d&#39;ensemble des services</span></a></h2><p>Le backend de MathQuest est organisé autour de plusieurs services métier qui gèrent les différentes fonctionnalités de l&#39;application. L&#39;architecture suit le principe de responsabilité unique avec une séparation claire entre les couches.</p><h2 id="architecture-des-services" tabindex="-1"><a class="header-anchor" href="#architecture-des-services"><span>Architecture des services</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">backend/src/core/services/</span>
<span class="line">├── scoringService.ts          # Calcul des scores et pénalités</span>
<span class="line">├── canonicalTimerService.ts   # Gestion centralisée des timers</span>
<span class="line">├── gameStateService.ts        # État des parties (Redis)</span>
<span class="line">├── gameParticipantService.ts  # Gestion des participants</span>
<span class="line">├── timerKeyUtil.ts           # Utilitaires pour les clés Redis</span>
<span class="line">└── ...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gestion-des-evenements-quiz" tabindex="-1"><a class="header-anchor" href="#gestion-des-evenements-quiz"><span>Gestion des événements quiz</span></a></h2><h3 id="flux-d-un-evenement-quiz-typique" tabindex="-1"><a class="header-anchor" href="#flux-d-un-evenement-quiz-typique"><span>Flux d&#39;un événement quiz typique</span></a></h3><ol><li><strong>Réception de la réponse</strong> (<code>GAME_ANSWER</code>)</li><li><strong>Validation de la payload</strong></li><li><strong>Résolution du contexte</strong> (gameInstance, participant, question)</li><li><strong>Calcul du score</strong> via <code>ScoringService</code></li><li><strong>Mise à jour de la base de données</strong></li><li><strong>Diffusion des mises à jour</strong> via Socket.IO</li></ol><h3 id="gestionnaire-principal-game-index-ts" tabindex="-1"><a class="header-anchor" href="#gestionnaire-principal-game-index-ts"><span>Gestionnaire principal (<code>game/index.ts</code>)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Extrait du gestionnaire GAME_ANSWER</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token constant">GAME_EVENTS</span><span class="token punctuation">.</span><span class="token constant">GAME_ANSWER</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 1. Validation du payload avec Zod</span></span>
<span class="line">  <span class="token keyword">const</span> parseResult <span class="token operator">=</span> AnswerSubmissionPayloadSchema<span class="token punctuation">.</span><span class="token function">safeParse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 2. Résolution du contexte</span></span>
<span class="line">  <span class="token keyword">const</span> gameInstance <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>gameInstance<span class="token punctuation">.</span><span class="token function">findUnique</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    where<span class="token operator">:</span> <span class="token punctuation">{</span> accessCode<span class="token operator">:</span> payload<span class="token punctuation">.</span>accessCode <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 3. Récupération du participant</span></span>
<span class="line">  <span class="token keyword">const</span> participant <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>gameParticipant<span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    where<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      gameInstanceId<span class="token operator">:</span> gameInstance<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">      userId<span class="token operator">:</span> payload<span class="token punctuation">.</span>userId</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 4. Calcul du score</span></span>
<span class="line">  <span class="token keyword">const</span> scoreResult <span class="token operator">=</span> <span class="token keyword">await</span> ScoringService<span class="token punctuation">.</span><span class="token function">submitAnswerWithScoring</span><span class="token punctuation">(</span></span>
<span class="line">    gameInstance<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">    payload<span class="token punctuation">.</span>userId<span class="token punctuation">,</span></span>
<span class="line">    answerData</span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 5. Diffusion des résultats</span></span>
<span class="line">  io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token constant">GAME_EVENTS</span><span class="token punctuation">.</span><span class="token constant">LEADERBOARD_UPDATE</span><span class="token punctuation">,</span> leaderboard<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="service-de-scoring-scoringservice" tabindex="-1"><a class="header-anchor" href="#service-de-scoring-scoringservice"><span>Service de scoring (<code>ScoringService</code>)</span></a></h2><h3 id="interface-principale" tabindex="-1"><a class="header-anchor" href="#interface-principale"><span>Interface principale</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">interface</span> <span class="token class-name">ScoreResult</span> <span class="token punctuation">{</span></span>
<span class="line">  scoreUpdated<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span></span>
<span class="line">  scoreAdded<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  totalScore<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  answerChanged<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span></span>
<span class="line">  previousAnswer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>
<span class="line">  message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line">  timePenalty<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ScoringService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">submitAnswerWithScoring</span><span class="token punctuation">(</span></span>
<span class="line">    gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    answerData<span class="token operator">:</span> AnswerSubmissionPayload</span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ScoreResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Logique complète de scoring</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">calculateAnswerScore</span><span class="token punctuation">(</span></span>
<span class="line">    question<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span></span>
<span class="line">    answer<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span></span>
<span class="line">    serverTimeSpent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>
<span class="line">    totalPresentationTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>
<span class="line">    accessCode<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">{</span> score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> timePenalty<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Calcul détaillé du score</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="fonctionnement-interne" tabindex="-1"><a class="header-anchor" href="#fonctionnement-interne"><span>Fonctionnement interne</span></a></h3><ol><li><strong>Validation de l&#39;intégrité</strong> : Vérification que la réponse n&#39;a pas été modifiée</li><li><strong>Calcul de la correction</strong> : Selon le type de question (QCM/numérique)</li><li><strong>Application des pénalités</strong> : Temporelles et selon les redémarrages</li><li><strong>Mise à jour atomique</strong> : Score en base + cache Redis</li></ol><h2 id="service-des-timers-canonicaltimerservice" tabindex="-1"><a class="header-anchor" href="#service-des-timers-canonicaltimerservice"><span>Service des timers (<code>CanonicalTimerService</code>)</span></a></h2><h3 id="role-central" tabindex="-1"><a class="header-anchor" href="#role-central"><span>Rôle central</span></a></h3><p>Le <code>CanonicalTimerService</code> gère tous les aspects temporels :</p><ul><li><strong>Démarrage des timers</strong> pour chaque question</li><li><strong>Suivi du temps serveur</strong> vs temps client</li><li><strong>Gestion des redémarrages</strong> de timer</li><li><strong>Calcul des pénalités</strong> basées sur le temps</li></ul><h3 id="structure-des-donnees-redis" tabindex="-1"><a class="header-anchor" href="#structure-des-donnees-redis"><span>Structure des données Redis</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// Clé : mathquest:timer:{accessCode}:{questionUid}</span></span>
<span class="line"><span class="token comment">// Valeur :</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;durationMs&quot;</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>           <span class="token comment">// Durée totale en ms</span></span>
<span class="line">  <span class="token string-property property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token number">1640000000000</span><span class="token punctuation">,</span>    <span class="token comment">// Timestamp de démarrage</span></span>
<span class="line">  <span class="token string-property property">&quot;restartCount&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment">// Nombre de redémarrages</span></span>
<span class="line">  <span class="token string-property property">&quot;lastRestartTime&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>       <span class="token comment">// Dernier redémarrage</span></span>
<span class="line">  <span class="token string-property property">&quot;totalPausedTime&quot;</span><span class="token operator">:</span> <span class="token number">0</span>           <span class="token comment">// Temps total en pause</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="methodes-principales" tabindex="-1"><a class="header-anchor" href="#methodes-principales"><span>Méthodes principales</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">CanonicalTimerService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">startTimer</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> durationMs<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">getRemainingTime</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">restartTimer</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">getServerTimeSpent</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="service-d-etat-des-parties-gamestateservice" tabindex="-1"><a class="header-anchor" href="#service-d-etat-des-parties-gamestateservice"><span>Service d&#39;état des parties (<code>GameStateService</code>)</span></a></h2><h3 id="stockage-en-redis" tabindex="-1"><a class="header-anchor" href="#stockage-en-redis"><span>Stockage en Redis</span></a></h3><p>L&#39;état des parties est stocké dans Redis pour des accès rapides :</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// Clé : mathquest:game:{accessCode}</span></span>
<span class="line"><span class="token comment">// Valeur :</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;gameState&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;questionUids&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;q1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;q2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;q3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;currentQuestionIndex&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token number">1640000000000</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;participants&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;user123&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;answers&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;q1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;q2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;B&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="methodes-cles" tabindex="-1"><a class="header-anchor" href="#methodes-cles"><span>Méthodes clés</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">GameStateService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getFullGameState</span><span class="token punctuation">(</span>sessionKey<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">updateParticipantScore</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">addParticipant</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">removeParticipant</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gestion-des-participants" tabindex="-1"><a class="header-anchor" href="#gestion-des-participants"><span>Gestion des participants</span></a></h2><h3 id="service-dedie-gameparticipantservice" tabindex="-1"><a class="header-anchor" href="#service-dedie-gameparticipantservice"><span>Service dédié (<code>GameParticipantService</code>)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">GameParticipantService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">joinGame</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>JoinResult<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">leaveGame</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">updateScore</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getLeaderboard</span><span class="token punctuation">(</span>gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>LeaderboardEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="flux-d-integration-d-un-participant" tabindex="-1"><a class="header-anchor" href="#flux-d-integration-d-un-participant"><span>Flux d&#39;intégration d&#39;un participant</span></a></h3><ol><li><strong>Validation du code d&#39;accès</strong></li><li><strong>Vérification des droits</strong> (place disponible, partie pas commencée)</li><li><strong>Création de l&#39;entrée</strong> en base de données</li><li><strong>Ajout au cache Redis</strong></li><li><strong>Notification Socket.IO</strong> aux autres participants</li></ol><h2 id="communication-socket-io" tabindex="-1"><a class="header-anchor" href="#communication-socket-io"><span>Communication Socket.IO</span></a></h2><h3 id="evenements-principaux" tabindex="-1"><a class="header-anchor" href="#evenements-principaux"><span>Événements principaux</span></a></h3><h4 id="cote-client-→-serveur" tabindex="-1"><a class="header-anchor" href="#cote-client-→-serveur"><span>Côté client → serveur</span></a></h4><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Rejoindre une partie</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;JOIN_GAME&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  accessCode<span class="token operator">:</span> <span class="token string">&#39;ABC123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  userId<span class="token operator">:</span> <span class="token string">&#39;user123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  username<span class="token operator">:</span> <span class="token string">&#39;Alice&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Soumettre une réponse</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;GAME_ANSWER&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  accessCode<span class="token operator">:</span> <span class="token string">&#39;ABC123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  userId<span class="token operator">:</span> <span class="token string">&#39;user123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  questionUid<span class="token operator">:</span> <span class="token string">&#39;q1&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  answer<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  timeSpent<span class="token operator">:</span> <span class="token number">25000</span>  <span class="token comment">// millisecondes</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cote-serveur-→-client" tabindex="-1"><a class="header-anchor" href="#cote-serveur-→-client"><span>Côté serveur → client</span></a></h4><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Nouvelle question</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;QUESTION_START&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  question<span class="token operator">:</span> questionData<span class="token punctuation">,</span></span>
<span class="line">  timeLimit<span class="token operator">:</span> <span class="token number">60000</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Mise à jour du leaderboard</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;LEADERBOARD_UPDATE&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  leaderboard<span class="token operator">:</span> sortedParticipants<span class="token punctuation">,</span></span>
<span class="line">  currentQuestionIndex<span class="token operator">:</span> <span class="token number">2</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Fin de la partie</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;GAME_END&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  finalLeaderboard<span class="token operator">:</span> finalResults<span class="token punctuation">,</span></span>
<span class="line">  winner<span class="token operator">:</span> topParticipant</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gestion-des-rooms" tabindex="-1"><a class="header-anchor" href="#gestion-des-rooms"><span>Gestion des rooms</span></a></h3><p>Chaque partie utilise une &quot;room&quot; Socket.IO isolée :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Rejoindre la room de la partie</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Émettre uniquement aux participants de cette partie</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;event&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Quitter la room</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">leave</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gestion-des-erreurs-et-logging" tabindex="-1"><a class="header-anchor" href="#gestion-des-erreurs-et-logging"><span>Gestion des erreurs et logging</span></a></h2><h3 id="middleware-de-logging" tabindex="-1"><a class="header-anchor" href="#middleware-de-logging"><span>Middleware de logging</span></a></h3><p>Tous les services utilisent un logger centralisé :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> createLogger <span class="token keyword">from</span> <span class="token string">&#39;@/utils/logger&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token string">&#39;ScoringService&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  userId<span class="token punctuation">,</span></span>
<span class="line">  gameInstanceId<span class="token punctuation">,</span></span>
<span class="line">  score<span class="token operator">:</span> result<span class="token punctuation">.</span>score<span class="token punctuation">,</span></span>
<span class="line">  timePenalty<span class="token operator">:</span> result<span class="token punctuation">.</span>timePenalty</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Score calculated successfully&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gestion-des-erreurs" tabindex="-1"><a class="header-anchor" href="#gestion-des-erreurs"><span>Gestion des erreurs</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ScoringService<span class="token punctuation">.</span><span class="token function">calculateAnswerScore</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> questionUid <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Failed to calculate score&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">&#39;Score calculation failed&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="optimisations-de-performance" tabindex="-1"><a class="header-anchor" href="#optimisations-de-performance"><span>Optimisations de performance</span></a></h2><h3 id="cache-redis" tabindex="-1"><a class="header-anchor" href="#cache-redis"><span>Cache Redis</span></a></h3><ul><li><strong>État des parties</strong> : Accès O(1) aux données de session</li><li><strong>Timers</strong> : Suivi précis du temps serveur</li><li><strong>Leaderboards</strong> : Mise à jour atomique des scores</li></ul><h3 id="base-de-donnees" tabindex="-1"><a class="header-anchor" href="#base-de-donnees"><span>Base de données</span></a></h3><ul><li><strong>Index composites</strong> sur les requêtes fréquentes</li><li><strong>Pooling de connexions</strong> pour éviter la surcharge</li><li><strong>Transactions</strong> pour les opérations critiques</li></ul><h3 id="socket-io" tabindex="-1"><a class="header-anchor" href="#socket-io"><span>Socket.IO</span></a></h3><ul><li><strong>Compression</strong> des messages pour réduire la bande passante</li><li><strong>Batching</strong> des mises à jour pour éviter le spam</li><li><strong>Heartbeat</strong> pour détecter les déconnexions</li></ul><h2 id="tests-et-validation" tabindex="-1"><a class="header-anchor" href="#tests-et-validation"><span>Tests et validation</span></a></h2><h3 id="tests-unitaires" tabindex="-1"><a class="header-anchor" href="#tests-unitaires"><span>Tests unitaires</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;ScoringService&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#39;should calculate correct score for perfect QCM answer&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ScoringService<span class="token punctuation">.</span><span class="token function">calculateAnswerScore</span><span class="token punctuation">(</span></span>
<span class="line">      mockQuestion<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Correct answer</span></span>
<span class="line">      <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// 30 seconds</span></span>
<span class="line">      <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// Same as server time</span></span>
<span class="line">      <span class="token string">&#39;TEST123&#39;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeGreaterThan</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>timePenalty<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeLessThan</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="tests-d-integration" tabindex="-1"><a class="header-anchor" href="#tests-d-integration"><span>Tests d&#39;intégration</span></a></h3><p>Les tests d&#39;intégration valident les interactions entre services :</p><ul><li><strong>Flux complet</strong> : De la réponse à la mise à jour du leaderboard</li><li><strong>Concurrence</strong> : Gestion des réponses simultanées</li><li><strong>Déconnexions</strong> : Récupération après perte de connexion</li></ul><p>Cette architecture modulaire assure la maintenabilité, l&#39;évolutivité et la fiabilité du système de gestion des quiz de MathQuest.</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Dernière mise à jour: </span><time class="meta-item-info" datetime="2025-09-19T13:01:15.000Z" data-allow-mismatch>19/09/2025 15:01</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: alexis.flesch@gmail.com">alexisflesch</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/mathquest/details-techniques/scoring.html" aria-label="Système de scoring"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">Système de scoring</span></div><!--]--></a><a class="route-link auto-link next" href="/mathquest/details-techniques/api.html" aria-label="API REST"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">API REST</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/mathquest/assets/app-DoDG4mLI.js" defer></script>
  </body>
</html>
