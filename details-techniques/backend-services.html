<!doctype html>
<html lang="fr-FR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.23" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/styles/screenshots.css"><title>Services backend | Kutsum</title><meta name="description" content="Alternative libre et open source à Kahoot, pour les enseignants et leurs élèves.">
    <link rel="preload" href="/assets/style-Dkmw-xJK.css" as="style"><link rel="stylesheet" href="/assets/style-Dkmw-xJK.css">
    <link rel="modulepreload" href="/assets/app-Blvv7Pu1.js"><link rel="modulepreload" href="/assets/backend-services.html-B5XZ0b45.js">
    <link rel="prefetch" href="/assets/index.html-BgWsLJk5.js" as="script"><link rel="prefetch" href="/assets/index.html-CxFhQ9yh.js" as="script"><link rel="prefetch" href="/assets/api.html-B_bdbqlW.js" as="script"><link rel="prefetch" href="/assets/architecture.html-C2TIKhjm.js" as="script"><link rel="prefetch" href="/assets/configuration.html-CSBv4zlE.js" as="script"><link rel="prefetch" href="/assets/database.html-zDPra4qo.js" as="script"><link rel="prefetch" href="/assets/deployement.html-Cb8coLaH.js" as="script"><link rel="prefetch" href="/assets/landing-page.html-DFa_9Yed.js" as="script"><link rel="prefetch" href="/assets/performance-monitoring.html-DkqiKT9u.js" as="script"><link rel="prefetch" href="/assets/question-editor.html-KCmeVQ8t.js" as="script"><link rel="prefetch" href="/assets/scoring.html-BgDchvD2.js" as="script"><link rel="prefetch" href="/assets/security.html-CR7bBL-N.js" as="script"><link rel="prefetch" href="/assets/tests.html-DOtCFwSL.js" as="script"><link rel="prefetch" href="/assets/troubleshooting.html-G-04tDSs.js" as="script"><link rel="prefetch" href="/assets/diagnostics.html-DKbQEDup.js" as="script"><link rel="prefetch" href="/assets/observability.html-DkPbL3ic.js" as="script"><link rel="prefetch" href="/assets/index.html-Tv1AKkVx.js" as="script"><link rel="prefetch" href="/assets/index.html-D4Ge4R3B.js" as="script"><link rel="prefetch" href="/assets/aflesch-espaces-vectoriels-notes.html-CarfwQKl.js" as="script"><link rel="prefetch" href="/assets/contribuer.html-BFpj89FN.js" as="script"><link rel="prefetch" href="/assets/index.html-JVJ8j1aq.js" as="script"><link rel="prefetch" href="/assets/entrainement.html-DAbAqH-4.js" as="script"><link rel="prefetch" href="/assets/quiz.html-H3MzSQm9.js" as="script"><link rel="prefetch" href="/assets/tournoi.html-DylmTv1c.js" as="script"><link rel="prefetch" href="/assets/404.html-T_x5-zmb.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/assets/logo.svg" alt="Kutsum"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">Kutsum</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Accueil"><!--[--><!--[--><!--]--><!--]-->Accueil<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/utilisation/" aria-label="Utilisation de l&#39;appli"><!--[--><!--[--><!--]--><!--]-->Utilisation de l&#39;appli<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/questions-yaml/" aria-label="Création de questions"><!--[--><!--[--><!--]--><!--]-->Création de questions<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/installation/" aria-label="Installation"><!--[--><!--[--><!--]--><!--]-->Installation<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/details-techniques/" aria-label="Détails techniques"><!--[--><!--[--><!--]--><!--]-->Détails techniques<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/dev/" aria-label="Dev"><!--[--><!--[--><!--]--><!--]-->Dev<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Accueil"><!--[--><!--[--><!--]--><!--]-->Accueil<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/utilisation/" aria-label="Utilisation de l&#39;appli"><!--[--><!--[--><!--]--><!--]-->Utilisation de l&#39;appli<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/questions-yaml/" aria-label="Création de questions"><!--[--><!--[--><!--]--><!--]-->Création de questions<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/installation/" aria-label="Installation"><!--[--><!--[--><!--]--><!--]-->Installation<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/details-techniques/" aria-label="Détails techniques"><!--[--><!--[--><!--]--><!--]-->Détails techniques<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/dev/" aria-label="Dev"><!--[--><!--[--><!--]--><!--]-->Dev<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">Détails techniques (utilisateurs avancés seulement) <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item" href="/details-techniques/" aria-label="Détails techniques (utilisateurs avancés seulement)"><!--[--><!--[--><!--]--><!--]-->Détails techniques (utilisateurs avancés seulement)<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/architecture.html" aria-label="Architecture générale"><!--[--><!--[--><!--]--><!--]-->Architecture générale<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/database.html" aria-label="Base de données"><!--[--><!--[--><!--]--><!--]-->Base de données<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/scoring.html" aria-label="Système de scoring"><!--[--><!--[--><!--]--><!--]-->Système de scoring<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/details-techniques/backend-services.html" aria-label="Services backend"><!--[--><!--[--><!--]--><!--]-->Services backend<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/api.html" aria-label="API REST"><!--[--><!--[--><!--]--><!--]-->API REST<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/configuration.html" aria-label="Configuration et environnement"><!--[--><!--[--><!--]--><!--]-->Configuration et environnement<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/tests.html" aria-label="Tests et qualité"><!--[--><!--[--><!--]--><!--]-->Tests et qualité<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/deployement.html" aria-label="Déploiement et DevOps"><!--[--><!--[--><!--]--><!--]-->Déploiement et DevOps<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/security.html" aria-label="Security Documentation"><!--[--><!--[--><!--]--><!--]-->Security Documentation<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/performance-monitoring.html" aria-label="Performance &amp; Monitoring"><!--[--><!--[--><!--]--><!--]-->Performance &amp; Monitoring<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/troubleshooting.html" aria-label="Troubleshooting Guide"><!--[--><!--[--><!--]--><!--]-->Troubleshooting Guide<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/question-editor.html" aria-label="Éditeur de Questions pour Enseignants"><!--[--><!--[--><!--]--><!--]-->Éditeur de Questions pour Enseignants<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/details-techniques/landing-page.html" aria-label="Landing Page Variants (App)"><!--[--><!--[--><!--]--><!--]-->Landing Page Variants (App)<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h1 id="services-backend" tabindex="-1"><a class="header-anchor" href="#services-backend"><span>Services backend</span></a></h1><h2 id="vue-d-ensemble-des-services" tabindex="-1"><a class="header-anchor" href="#vue-d-ensemble-des-services"><span>Vue d&#39;ensemble des services</span></a></h2><p>Le backend de MathQuest est organisé autour de plusieurs services métier qui gèrent les différentes fonctionnalités de l&#39;application. L&#39;architecture suit le principe de responsabilité unique avec une séparation claire entre les couches.</p><h2 id="architecture-des-services" tabindex="-1"><a class="header-anchor" href="#architecture-des-services"><span>Architecture des services</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">backend/src/core/services/</span>
<span class="line">├── scoringService.ts          # Calcul des scores et pénalités</span>
<span class="line">├── canonicalTimerService.ts   # Gestion centralisée des timers</span>
<span class="line">├── gameStateService.ts        # État des parties (Redis)</span>
<span class="line">├── gameParticipantService.ts  # Gestion des participants</span>
<span class="line">├── timerKeyUtil.ts           # Utilitaires pour les clés Redis</span>
<span class="line">└── ...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gestion-des-evenements-quiz" tabindex="-1"><a class="header-anchor" href="#gestion-des-evenements-quiz"><span>Gestion des événements quiz</span></a></h2><h3 id="flux-d-un-evenement-quiz-typique" tabindex="-1"><a class="header-anchor" href="#flux-d-un-evenement-quiz-typique"><span>Flux d&#39;un événement quiz typique</span></a></h3><ol><li><strong>Réception de la réponse</strong> (<code>GAME_ANSWER</code>)</li><li><strong>Validation de la payload</strong></li><li><strong>Résolution du contexte</strong> (gameInstance, participant, question)</li><li><strong>Calcul du score</strong> via <code>ScoringService</code></li><li><strong>Mise à jour de la base de données</strong></li><li><strong>Diffusion des mises à jour</strong> via Socket.IO</li></ol><h3 id="gestionnaire-principal-game-index-ts" tabindex="-1"><a class="header-anchor" href="#gestionnaire-principal-game-index-ts"><span>Gestionnaire principal (<code>game/index.ts</code>)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Extrait du gestionnaire GAME_ANSWER</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token constant">GAME_EVENTS</span><span class="token punctuation">.</span><span class="token constant">GAME_ANSWER</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 1. Validation du payload avec Zod</span></span>
<span class="line">  <span class="token keyword">const</span> parseResult <span class="token operator">=</span> AnswerSubmissionPayloadSchema<span class="token punctuation">.</span><span class="token function">safeParse</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 2. Résolution du contexte</span></span>
<span class="line">  <span class="token keyword">const</span> gameInstance <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>gameInstance<span class="token punctuation">.</span><span class="token function">findUnique</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    where<span class="token operator">:</span> <span class="token punctuation">{</span> accessCode<span class="token operator">:</span> payload<span class="token punctuation">.</span>accessCode <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 3. Récupération du participant</span></span>
<span class="line">  <span class="token keyword">const</span> participant <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>gameParticipant<span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    where<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      gameInstanceId<span class="token operator">:</span> gameInstance<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">      userId<span class="token operator">:</span> payload<span class="token punctuation">.</span>userId</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 4. Calcul du score</span></span>
<span class="line">  <span class="token keyword">const</span> scoreResult <span class="token operator">=</span> <span class="token keyword">await</span> ScoringService<span class="token punctuation">.</span><span class="token function">submitAnswerWithScoring</span><span class="token punctuation">(</span></span>
<span class="line">    gameInstance<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">    payload<span class="token punctuation">.</span>userId<span class="token punctuation">,</span></span>
<span class="line">    answerData</span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 5. Diffusion des résultats</span></span>
<span class="line">  io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token constant">GAME_EVENTS</span><span class="token punctuation">.</span><span class="token constant">LEADERBOARD_UPDATE</span><span class="token punctuation">,</span> leaderboard<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="service-de-scoring-scoringservice" tabindex="-1"><a class="header-anchor" href="#service-de-scoring-scoringservice"><span>Service de scoring (<code>ScoringService</code>)</span></a></h2><h3 id="interface-principale" tabindex="-1"><a class="header-anchor" href="#interface-principale"><span>Interface principale</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">interface</span> <span class="token class-name">ScoreResult</span> <span class="token punctuation">{</span></span>
<span class="line">  scoreUpdated<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span></span>
<span class="line">  scoreAdded<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  totalScore<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  answerChanged<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span></span>
<span class="line">  previousAnswer<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>
<span class="line">  message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line">  timePenalty<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ScoringService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">submitAnswerWithScoring</span><span class="token punctuation">(</span></span>
<span class="line">    gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    answerData<span class="token operator">:</span> AnswerSubmissionPayload</span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ScoreResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Logique complète de scoring</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">calculateAnswerScore</span><span class="token punctuation">(</span></span>
<span class="line">    question<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span></span>
<span class="line">    answer<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span></span>
<span class="line">    serverTimeSpent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>
<span class="line">    totalPresentationTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span></span>
<span class="line">    accessCode<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token punctuation">{</span> score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> timePenalty<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Calcul détaillé du score</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="fonctionnement-interne" tabindex="-1"><a class="header-anchor" href="#fonctionnement-interne"><span>Fonctionnement interne</span></a></h3><ol><li><strong>Validation de l&#39;intégrité</strong> : Vérification que la réponse n&#39;a pas été modifiée</li><li><strong>Calcul de la correction</strong> : Selon le type de question (QCM/numérique)</li><li><strong>Application des pénalités</strong> : Temporelles et selon les redémarrages</li><li><strong>Mise à jour atomique</strong> : Score en base + cache Redis</li></ol><h2 id="service-des-timers-canonicaltimerservice" tabindex="-1"><a class="header-anchor" href="#service-des-timers-canonicaltimerservice"><span>Service des timers (<code>CanonicalTimerService</code>)</span></a></h2><h3 id="role-central" tabindex="-1"><a class="header-anchor" href="#role-central"><span>Rôle central</span></a></h3><p>Le <code>CanonicalTimerService</code> gère tous les aspects temporels :</p><ul><li><strong>Démarrage des timers</strong> pour chaque question</li><li><strong>Suivi du temps serveur</strong> vs temps client</li><li><strong>Gestion des redémarrages</strong> de timer</li><li><strong>Calcul des pénalités</strong> basées sur le temps</li></ul><h3 id="structure-des-donnees-redis" tabindex="-1"><a class="header-anchor" href="#structure-des-donnees-redis"><span>Structure des données Redis</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// Clé : mathquest:timer:{accessCode}:{questionUid}</span></span>
<span class="line"><span class="token comment">// Valeur :</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;durationMs&quot;</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>           <span class="token comment">// Durée totale en ms</span></span>
<span class="line">  <span class="token string-property property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token number">1640000000000</span><span class="token punctuation">,</span>    <span class="token comment">// Timestamp de démarrage</span></span>
<span class="line">  <span class="token string-property property">&quot;restartCount&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>             <span class="token comment">// Nombre de redémarrages</span></span>
<span class="line">  <span class="token string-property property">&quot;lastRestartTime&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>       <span class="token comment">// Dernier redémarrage</span></span>
<span class="line">  <span class="token string-property property">&quot;totalPausedTime&quot;</span><span class="token operator">:</span> <span class="token number">0</span>           <span class="token comment">// Temps total en pause</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="methodes-principales" tabindex="-1"><a class="header-anchor" href="#methodes-principales"><span>Méthodes principales</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">CanonicalTimerService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">startTimer</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> durationMs<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">getRemainingTime</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">restartTimer</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">getServerTimeSpent</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> questionUid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="service-d-etat-des-parties-gamestateservice" tabindex="-1"><a class="header-anchor" href="#service-d-etat-des-parties-gamestateservice"><span>Service d&#39;état des parties (<code>GameStateService</code>)</span></a></h2><h3 id="stockage-en-redis" tabindex="-1"><a class="header-anchor" href="#stockage-en-redis"><span>Stockage en Redis</span></a></h3><p>L&#39;état des parties est stocké dans Redis pour des accès rapides :</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// Clé : mathquest:game:{accessCode}</span></span>
<span class="line"><span class="token comment">// Valeur :</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;gameState&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;questionUids&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;q1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;q2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;q3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;currentQuestionIndex&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token number">1640000000000</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;participants&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;user123&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;answers&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;q1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;q2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;B&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="methodes-cles" tabindex="-1"><a class="header-anchor" href="#methodes-cles"><span>Méthodes clés</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">GameStateService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getFullGameState</span><span class="token punctuation">(</span>sessionKey<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">updateParticipantScore</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">addParticipant</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">removeParticipant</span><span class="token punctuation">(</span>accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gestion-des-participants" tabindex="-1"><a class="header-anchor" href="#gestion-des-participants"><span>Gestion des participants</span></a></h2><h3 id="service-dedie-gameparticipantservice" tabindex="-1"><a class="header-anchor" href="#service-dedie-gameparticipantservice"><span>Service dédié (<code>GameParticipantService</code>)</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">GameParticipantService</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">joinGame</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> accessCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>JoinResult<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">leaveGame</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">updateScore</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getLeaderboard</span><span class="token punctuation">(</span>gameInstanceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>LeaderboardEntry<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="flux-d-integration-d-un-participant" tabindex="-1"><a class="header-anchor" href="#flux-d-integration-d-un-participant"><span>Flux d&#39;intégration d&#39;un participant</span></a></h3><ol><li><strong>Validation du code d&#39;accès</strong></li><li><strong>Vérification des droits</strong> (place disponible, partie pas commencée)</li><li><strong>Création de l&#39;entrée</strong> en base de données</li><li><strong>Ajout au cache Redis</strong></li><li><strong>Notification Socket.IO</strong> aux autres participants</li></ol><h2 id="communication-socket-io" tabindex="-1"><a class="header-anchor" href="#communication-socket-io"><span>Communication Socket.IO</span></a></h2><h3 id="evenements-principaux" tabindex="-1"><a class="header-anchor" href="#evenements-principaux"><span>Événements principaux</span></a></h3><h4 id="cote-client-→-serveur" tabindex="-1"><a class="header-anchor" href="#cote-client-→-serveur"><span>Côté client → serveur</span></a></h4><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Rejoindre une partie</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;JOIN_GAME&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  accessCode<span class="token operator">:</span> <span class="token string">&#39;ABC123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  userId<span class="token operator">:</span> <span class="token string">&#39;user123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  username<span class="token operator">:</span> <span class="token string">&#39;Alice&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Soumettre une réponse</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;GAME_ANSWER&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  accessCode<span class="token operator">:</span> <span class="token string">&#39;ABC123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  userId<span class="token operator">:</span> <span class="token string">&#39;user123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  questionUid<span class="token operator">:</span> <span class="token string">&#39;q1&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  answer<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  timeSpent<span class="token operator">:</span> <span class="token number">25000</span>  <span class="token comment">// millisecondes</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cote-serveur-→-client" tabindex="-1"><a class="header-anchor" href="#cote-serveur-→-client"><span>Côté serveur → client</span></a></h4><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Nouvelle question</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;QUESTION_START&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  question<span class="token operator">:</span> questionData<span class="token punctuation">,</span></span>
<span class="line">  timeLimit<span class="token operator">:</span> <span class="token number">60000</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Mise à jour du leaderboard</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;LEADERBOARD_UPDATE&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  leaderboard<span class="token operator">:</span> sortedParticipants<span class="token punctuation">,</span></span>
<span class="line">  currentQuestionIndex<span class="token operator">:</span> <span class="token number">2</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Fin de la partie</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;GAME_END&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  finalLeaderboard<span class="token operator">:</span> finalResults<span class="token punctuation">,</span></span>
<span class="line">  winner<span class="token operator">:</span> topParticipant</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gestion-des-rooms" tabindex="-1"><a class="header-anchor" href="#gestion-des-rooms"><span>Gestion des rooms</span></a></h3><p>Chaque partie utilise une &quot;room&quot; Socket.IO isolée :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Rejoindre la room de la partie</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Émettre uniquement aux participants de cette partie</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;event&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Quitter la room</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">leave</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gestion-des-erreurs-et-logging" tabindex="-1"><a class="header-anchor" href="#gestion-des-erreurs-et-logging"><span>Gestion des erreurs et logging</span></a></h2><h3 id="middleware-de-logging" tabindex="-1"><a class="header-anchor" href="#middleware-de-logging"><span>Middleware de logging</span></a></h3><p>Tous les services utilisent un logger centralisé :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> createLogger <span class="token keyword">from</span> <span class="token string">&#39;@/utils/logger&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token string">&#39;ScoringService&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  userId<span class="token punctuation">,</span></span>
<span class="line">  gameInstanceId<span class="token punctuation">,</span></span>
<span class="line">  score<span class="token operator">:</span> result<span class="token punctuation">.</span>score<span class="token punctuation">,</span></span>
<span class="line">  timePenalty<span class="token operator">:</span> result<span class="token punctuation">.</span>timePenalty</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Score calculated successfully&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gestion-des-erreurs" tabindex="-1"><a class="header-anchor" href="#gestion-des-erreurs"><span>Gestion des erreurs</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ScoringService<span class="token punctuation">.</span><span class="token function">calculateAnswerScore</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> questionUid <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Failed to calculate score&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">&#39;Score calculation failed&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="optimisations-de-performance" tabindex="-1"><a class="header-anchor" href="#optimisations-de-performance"><span>Optimisations de performance</span></a></h2><h3 id="cache-redis" tabindex="-1"><a class="header-anchor" href="#cache-redis"><span>Cache Redis</span></a></h3><ul><li><strong>État des parties</strong> : Accès O(1) aux données de session</li><li><strong>Timers</strong> : Suivi précis du temps serveur</li><li><strong>Leaderboards</strong> : Mise à jour atomique des scores</li></ul><h3 id="base-de-donnees" tabindex="-1"><a class="header-anchor" href="#base-de-donnees"><span>Base de données</span></a></h3><ul><li><strong>Index composites</strong> sur les requêtes fréquentes</li><li><strong>Pooling de connexions</strong> pour éviter la surcharge</li><li><strong>Transactions</strong> pour les opérations critiques</li></ul><h3 id="socket-io" tabindex="-1"><a class="header-anchor" href="#socket-io"><span>Socket.IO</span></a></h3><ul><li><strong>Compression</strong> des messages pour réduire la bande passante</li><li><strong>Batching</strong> des mises à jour pour éviter le spam</li><li><strong>Heartbeat</strong> pour détecter les déconnexions</li></ul><h2 id="tests-et-validation" tabindex="-1"><a class="header-anchor" href="#tests-et-validation"><span>Tests et validation</span></a></h2><h3 id="tests-unitaires" tabindex="-1"><a class="header-anchor" href="#tests-unitaires"><span>Tests unitaires</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;ScoringService&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#39;should calculate correct score for perfect QCM answer&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ScoringService<span class="token punctuation">.</span><span class="token function">calculateAnswerScore</span><span class="token punctuation">(</span></span>
<span class="line">      mockQuestion<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">[</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Correct answer</span></span>
<span class="line">      <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// 30 seconds</span></span>
<span class="line">      <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// Same as server time</span></span>
<span class="line">      <span class="token string">&#39;TEST123&#39;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeGreaterThan</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>timePenalty<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeLessThan</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="tests-d-integration" tabindex="-1"><a class="header-anchor" href="#tests-d-integration"><span>Tests d&#39;intégration</span></a></h3><p>Les tests d&#39;intégration valident les interactions entre services :</p><ul><li><strong>Flux complet</strong> : De la réponse à la mise à jour du leaderboard</li><li><strong>Concurrence</strong> : Gestion des réponses simultanées</li><li><strong>Déconnexions</strong> : Récupération après perte de connexion</li></ul><p>Cette architecture modulaire assure la maintenabilité, l&#39;évolutivité et la fiabilité du système de gestion des quiz de MathQuest.</p><h2 id="evenements-socket-io" tabindex="-1"><a class="header-anchor" href="#evenements-socket-io"><span>Événements Socket.IO</span></a></h2><p>MathQuest utilise Socket.IO pour la communication temps réel bidirectionnelle entre le frontend et le backend. Tous les événements sont définis dans <code>shared/types/socket/events.ts</code> pour assurer la cohérence.</p><h3 id="evenements-enseignant-teacher-events" tabindex="-1"><a class="header-anchor" href="#evenements-enseignant-teacher-events"><span>Événements Enseignant (TEACHER_EVENTS)</span></a></h3><h4 id="connexion-et-etat" tabindex="-1"><a class="header-anchor" href="#connexion-et-etat"><span>Connexion et état</span></a></h4><ul><li><code>JOIN_DASHBOARD</code> : Rejoindre le tableau de bord enseignant</li><li><code>GET_GAME_STATE</code> : Récupérer l&#39;état actuel du jeu</li></ul><h4 id="controle-des-questions" tabindex="-1"><a class="header-anchor" href="#controle-des-questions"><span>Contrôle des questions</span></a></h4><ul><li><code>SET_QUESTION</code> : Définir la question active</li></ul><h4 id="controle-du-timer" tabindex="-1"><a class="header-anchor" href="#controle-du-timer"><span>Contrôle du timer</span></a></h4><ul><li><code>TIMER_ACTION</code> : Action générale sur le timer</li><li><code>START_TIMER</code> : Démarrer le timer</li><li><code>PAUSE_TIMER</code> : Mettre en pause le timer</li><li><code>TIMER_SET_DURATION</code> : Définir la durée du timer</li></ul><h4 id="controle-du-jeu" tabindex="-1"><a class="header-anchor" href="#controle-du-jeu"><span>Contrôle du jeu</span></a></h4><ul><li><code>LOCK_ANSWERS</code> : Verrouiller les réponses</li><li><code>END_GAME</code> : Terminer le jeu</li></ul><h4 id="actions-declenchees-par-l-enseignant" tabindex="-1"><a class="header-anchor" href="#actions-declenchees-par-l-enseignant"><span>Actions déclenchées par l&#39;enseignant</span></a></h4><ul><li><code>SHOW_CORRECT_ANSWERS</code> : Afficher les bonnes réponses</li><li><code>TOGGLE_PROJECTION_STATS</code> : Basculer les statistiques sur la projection</li><li><code>REVEAL_LEADERBOARD</code> : Révéler le classement</li></ul><h4 id="evenements-de-diffusion-serveur-→-client" tabindex="-1"><a class="header-anchor" href="#evenements-de-diffusion-serveur-→-client"><span>Événements de diffusion (serveur → client)</span></a></h4><ul><li><code>GAME_CONTROL_STATE</code> : État du contrôle du jeu</li><li><code>DASHBOARD_JOINED</code> : Confirmation de connexion au dashboard</li><li><code>TIMER_UPDATE</code> : Mise à jour du timer</li><li><code>CONNECTED_COUNT</code> : Nombre de connexions</li></ul><h4 id="evenements-specifiques-au-dashboard" tabindex="-1"><a class="header-anchor" href="#evenements-specifiques-au-dashboard"><span>Événements spécifiques au dashboard</span></a></h4><ul><li><code>DASHBOARD_QUESTION_CHANGED</code> : Question changée</li><li><code>DASHBOARD_TIMER_UPDATED</code> : Timer mis à jour</li><li><code>DASHBOARD_ANSWERS_LOCK_CHANGED</code> : Verrouillage des réponses changé</li><li><code>DASHBOARD_GAME_STATUS_CHANGED</code> : Statut du jeu changé</li><li><code>DASHBOARD_ANSWER_STATS_UPDATE</code> : Statistiques des réponses mises à jour</li></ul><h3 id="evenements-tournoi-tournament-events" tabindex="-1"><a class="header-anchor" href="#evenements-tournoi-tournament-events"><span>Événements Tournoi (TOURNAMENT_EVENTS)</span></a></h3><h4 id="actions-des-joueurs" tabindex="-1"><a class="header-anchor" href="#actions-des-joueurs"><span>Actions des joueurs</span></a></h4><ul><li><code>START_TOURNAMENT</code> : Démarrer un tournoi</li><li><code>JOIN_TOURNAMENT</code> : Rejoindre un tournoi</li><li><code>TOURNAMENT_ANSWER</code> : Soumettre une réponse au tournoi</li></ul><h4 id="reponses-du-serveur" tabindex="-1"><a class="header-anchor" href="#reponses-du-serveur"><span>Réponses du serveur</span></a></h4><ul><li><code>TOURNAMENT_STARTED</code> : Tournoi démarré</li><li><code>TOURNAMENT_JOINED</code> : Joueur rejoint le tournoi</li><li><code>TOURNAMENT_PLAYER_JOINED</code> : Nouveau joueur rejoint</li><li><code>TOURNAMENT_STATE_UPDATE</code> : Mise à jour de l&#39;état du tournoi</li><li><code>TOURNAMENT_ANSWER_RESULT</code> : Résultat de la réponse</li><li><code>TOURNAMENT_QUESTION_UPDATE</code> : Question mise à jour</li><li><code>TOURNAMENT_QUESTION_STATE_UPDATE</code> : État de la question mis à jour</li><li><code>TOURNAMENT_LEADERBOARD_UPDATE</code> : Classement mis à jour</li><li><code>TOURNAMENT_ENDED</code> : Tournoi terminé</li><li><code>TOURNAMENT_TIMER_UPDATE</code> : Timer mis à jour</li></ul><h3 id="evenements-de-projection-projector-events" tabindex="-1"><a class="header-anchor" href="#evenements-de-projection-projector-events"><span>Événements de Projection (PROJECTOR_EVENTS)</span></a></h3><h4 id="actions-de-projection" tabindex="-1"><a class="header-anchor" href="#actions-de-projection"><span>Actions de projection</span></a></h4><ul><li><code>JOIN_PROJECTION</code> : Rejoindre la projection</li><li><code>LEAVE_PROJECTION</code> : Quitter la projection</li></ul><h4 id="reponses-du-serveur-1" tabindex="-1"><a class="header-anchor" href="#reponses-du-serveur-1"><span>Réponses du serveur</span></a></h4><ul><li><code>PROJECTION_JOINED</code> : Projection rejointe</li><li><code>PROJECTION_LEFT</code> : Projection quittée</li><li><code>PROJECTION_ERROR</code> : Erreur de projection</li><li><code>PROJECTION_QUESTION_CHANGED</code> : Question changée sur la projection</li><li><code>PROJECTION_CONNECTED_COUNT</code> : Nombre de connexions à la projection</li><li><code>PROJECTION_STATE</code> : État de la projection</li><li><code>PROJECTION_LEADERBOARD_UPDATE</code> : Classement mis à jour sur la projection</li></ul><h4 id="controles-d-affichage" tabindex="-1"><a class="header-anchor" href="#controles-d-affichage"><span>Contrôles d&#39;affichage</span></a></h4><ul><li><code>PROJECTION_SHOW_STATS</code> : Afficher les statistiques</li><li><code>PROJECTION_HIDE_STATS</code> : Masquer les statistiques</li><li><code>PROJECTION_CORRECT_ANSWERS</code> : Afficher les bonnes réponses</li><li><code>PROJECTION_STATS_STATE</code> : État canonique des statistiques</li></ul><h3 id="evenements-de-jeu-quiz-game-events" tabindex="-1"><a class="header-anchor" href="#evenements-de-jeu-quiz-game-events"><span>Événements de Jeu/Quiz (GAME_EVENTS)</span></a></h3><h4 id="actions-des-joueurs-flux-de-connexion-unifie" tabindex="-1"><a class="header-anchor" href="#actions-des-joueurs-flux-de-connexion-unifie"><span>Actions des joueurs - Flux de connexion unifié</span></a></h4><ul><li><code>JOIN_GAME</code> : Rejoindre un jeu (remplace JOIN_LOBBY)</li><li><code>LEAVE_GAME</code> : Quitter un jeu (remplace LEAVE_LOBBY)</li><li><code>GAME_ANSWER</code> : Soumettre une réponse</li><li><code>REQUEST_PARTICIPANTS</code> : Demander la liste des participants</li><li><code>REQUEST_NEXT_QUESTION</code> : Demander la question suivante</li><li><code>START_GAME</code> : Démarrer le jeu</li></ul><h4 id="reponses-du-serveur-2" tabindex="-1"><a class="header-anchor" href="#reponses-du-serveur-2"><span>Réponses du serveur</span></a></h4><ul><li><code>GAME_JOINED</code> : Jeu rejoint</li><li><code>PLAYER_JOINED_GAME</code> : Nouveau joueur rejoint le jeu</li><li><code>PLAYER_LEFT_GAME</code> : Joueur a quitté le jeu</li><li><code>GAME_PARTICIPANTS</code> : Liste des participants</li><li><code>GAME_QUESTION</code> : Question du jeu</li><li><code>ANSWER_RECEIVED</code> : Réponse reçue</li><li><code>ANSWER_FEEDBACK</code> : Feedback de la réponse</li><li><code>GAME_ENDED</code> : Jeu terminé</li><li><code>GAME_ERROR</code> : Erreur de jeu</li><li><code>GAME_ANSWERS_LOCK_CHANGED</code> : Verrouillage des réponses changé</li><li><code>LEADERBOARD_UPDATE</code> : Mise à jour du classement</li></ul><h4 id="evenements-du-timer" tabindex="-1"><a class="header-anchor" href="#evenements-du-timer"><span>Événements du timer</span></a></h4><ul><li><code>GAME_TIMER_UPDATED</code> : Timer mis à jour (événement primaire)</li><li><code>TIMER_UPDATE</code> : Mise à jour du timer</li><li><code>GAME_UPDATE</code> : Mise à jour du jeu</li><li><code>TIMER_SET</code> : Timer défini</li></ul><h4 id="evenements-d-etat-du-jeu" tabindex="-1"><a class="header-anchor" href="#evenements-d-etat-du-jeu"><span>Événements d&#39;état du jeu</span></a></h4><ul><li><code>GAME_STATE_UPDATE</code> : Mise à jour de l&#39;état du jeu</li><li><code>CORRECT_ANSWERS</code> : Bonnes réponses</li><li><code>GAME_ALREADY_PLAYED</code> : Jeu déjà joué</li><li><code>GAME_REDIRECT_TO_LOBBY</code> : Redirection vers le lobby</li><li><code>GAME_CODE_UPDATED</code> : Code du jeu mis à jour</li><li><code>GAME_FINISHED_REDIRECT</code> : Redirection après fin du jeu</li></ul><h4 id="evenements-supplementaires" tabindex="-1"><a class="header-anchor" href="#evenements-supplementaires"><span>Événements supplémentaires</span></a></h4><ul><li><code>EXPLICATION</code> : Explication</li><li><code>FEEDBACK</code> : Feedback</li><li><code>LIVE_QUESTION</code> : Question en direct</li></ul><h3 id="gestion-des-rooms-socket-io" tabindex="-1"><a class="header-anchor" href="#gestion-des-rooms-socket-io"><span>Gestion des rooms Socket.IO</span></a></h3><p>Chaque partie utilise une &quot;room&quot; Socket.IO isolée pour la communication :</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Rejoindre la room d&#39;une partie</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Émettre uniquement aux participants de cette partie</span></span>
<span class="line">io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;event&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Quitter la room</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">leave</span><span class="token punctuation">(</span>accessCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="evenements-de-connexion" tabindex="-1"><a class="header-anchor" href="#evenements-de-connexion"><span>Événements de connexion</span></a></h3><ul><li><code>CONNECT</code> : Connexion établie</li><li><code>DISCONNECT</code> : Déconnexion</li><li><code>CONNECT_ERROR</code> : Erreur de connexion</li><li><code>CONNECTION_ESTABLISHED</code> : Connexion confirmée</li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Dernière mise à jour: </span><time class="meta-item-info" datetime="2025-10-29T13:30:16.000Z" data-allow-mismatch>29/10/2025 14:30</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: alexis.flesch@gmail.com">alexisflesch</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/details-techniques/scoring.html" aria-label="Système de scoring"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">Système de scoring</span></div><!--]--></a><a class="route-link auto-link next" href="/details-techniques/api.html" aria-label="API REST"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">API REST</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Blvv7Pu1.js" defer></script>
  </body>
</html>
